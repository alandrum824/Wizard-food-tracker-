<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogsworth Academy - Magical Nutrition Castle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&family=Celtic+Hand&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Magical Castle Background */
        .castle-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(25, 25, 112, 0.4) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            z-index: -2;
        }

        .castle-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.4), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 4s ease-in-out infinite alternate;
            z-index: 1;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Floating Magical Particles */
        .magical-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            animation: float 8s infinite linear;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10px) rotate(360deg) scale(1);
                opacity: 0;
            }
        }

        /* House Color Themes */
        .serpent { 
            --primary: #1a472a; 
            --secondary: #c0c0c0; 
            --accent: #2d5a3d;
            --house-glow: rgba(26, 71, 42, 0.6);
        }
        .griffin { 
            --primary: #740001; 
            --secondary: #ffd700; 
            --accent: #ae0001;
            --house-glow: rgba(116, 0, 1, 0.6);
        }
        .raven { 
            --primary: #0e1a40; 
            --secondary: #946b2d; 
            --accent: #222f5b;
            --house-glow: rgba(14, 26, 64, 0.6);
        }
        .hufflecrest { 
            --primary: #ecb939; 
            --secondary: #372e29; 
            --accent: #f0c75e;
            --house-glow: rgba(236, 185, 57, 0.6);
        }

        /* Castle Gate Entry */
        .castle-gate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
            background: radial-gradient(ellipse at center, rgba(139, 69, 19, 0.1), transparent);
        }

        .gate-scroll {
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.9), rgba(101, 67, 33, 0.8));
            border: 4px solid #8b4513;
            border-radius: 25px;
            padding: 3rem;
            text-align: center;
            box-shadow: 
                0 0 30px rgba(139, 69, 19, 0.8),
                inset 0 0 20px rgba(255, 215, 0, 0.1);
            max-width: 500px;
            position: relative;
        }

        .gate-scroll::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ffd700, #8b4513, #ffd700);
            border-radius: 30px;
            z-index: -1;
            animation: borderGlow 3s infinite;
        }

        @keyframes borderGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .academy-title {
            font-family: 'Cinzel', serif;
            font-size: 2.8rem;
            color: #ffd700;
            margin-bottom: 1rem;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8),
                0 0 20px rgba(255, 215, 0, 0.6);
            letter-spacing: 2px;
        }

        .academy-subtitle {
            font-size: 1.1rem;
            color: #f4e4bc;
            margin-bottom: 2rem;
            font-style: italic;
            line-height: 1.4;
        }

        .magical-input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: #ffd700;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .magical-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                inset 0 0 10px rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }

        .castle-btn {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(45deg, #8b4513, #a0522d);
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .castle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.3);
        }

        .guest-link {
            color: rgba(255, 215, 0, 0.8);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .guest-link:hover {
            color: #ffd700;
        }

        /* House Selection Great Hall */
        .great-hall {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .hall-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hall-title {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            color: #ffd700;
            margin-bottom: 1rem;
            text-shadow: 
                3px 3px 6px rgba(0,0,0,0.8),
                0 0 30px rgba(255, 215, 0, 0.6);
            letter-spacing: 3px;
        }

        .hall-subtitle {
            font-size: 1.3rem;
            color: #f4e4bc;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .sorting-text {
            font-size: 1.1rem;
            color: #ccc;
            max-width: 600px;
            line-height: 1.6;
        }

        .house-chamber {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2.5rem;
            max-width: 1200px;
            width: 100%;
        }

        .house-banner {
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.8), rgba(101, 67, 33, 0.6));
            border: 3px solid rgba(255, 215, 0, 0.4);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .house-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transform: rotate(-45deg);
            transition: all 0.8s ease;
            opacity: 0;
        }

        .house-banner:hover::before {
            opacity: 1;
            transform: rotate(-45deg) translate(50%, 50%);
        }

        .house-banner:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.6),
                0 0 40px var(--house-glow);
        }

        .house-banner.serpent { border-color: #1a472a; }
        .house-banner.griffin { border-color: #740001; }
        .house-banner.raven { border-color: #0e1a40; }
        .house-banner.hufflecrest { border-color: #ecb939; }

        .house-emblem {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            filter: drop-shadow(3px 3px 6px rgba(0, 0, 0, 0.8));
            transition: transform 0.4s ease;
        }

        .house-banner:hover .house-emblem {
            transform: scale(1.2) rotate(10deg);
        }

        .house-name {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .house-banner.serpent .house-name { color: #c0c0c0; }
        .house-banner.griffin .house-name { color: #ffd700; }
        .house-banner.raven .house-name { color: #946b2d; }
        .house-banner.hufflecrest .house-name { color: #372e29; }

        .house-values {
            font-style: italic;
            color: #e6d3a3;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .house-motto {
            font-size: 0.9rem;
            color: #ccc;
            font-weight: 600;
        }

        /* Main Castle Interface */
        .castle-main {
            display: none;
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* Navigation Tower */
        .nav-tower {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.9));
            border: 3px solid rgba(255, 215, 0, 0.6);
            border-radius: 20px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .castle-logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #ffd700;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .nav-buttons {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border: 2px solid var(--secondary);
            color: #fff;
            padding: 0.6rem 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.4),
                0 0 20px var(--house-glow);
        }

        /* House Banner in Main */
        .house-status {
            margin: 120px 20px 20px;
            background: linear-gradient(145deg, var(--primary), var(--accent));
            border: 3px solid var(--secondary);
            border-radius: 25px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.5),
                0 0 30px var(--house-glow);
        }

        .house-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 4s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .house-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .house-welcome {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
            font-style: italic;
            position: relative;
            z-index: 2;
        }

        .wizard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.2rem;
        }

        .stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* XP Crystal */
        .xp-crystal {
            margin: 1.5rem auto;
            position: relative;
            z-index: 2;
        }

        .crystal-container {
            width: 250px;
            height: 35px;
            background: linear-gradient(90deg, #000, #333);
            border-radius: 20px;
            border: 3px solid var(--secondary);
            overflow: hidden;
            position: relative;
            margin: 0 auto;
        }

        .crystal-fill {
            height: 100%;
            background: linear-gradient(90deg, #9333ea, #c084fc, #e879f9);
            border-radius: 20px;
            position: relative;
            transition: width 1.2s ease;
        }

        .crystal-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: crystalShimmer 3s infinite;
        }

        @keyframes crystalShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-text {
            text-align: center;
            margin-top: 0.8rem;
            font-weight: bold;
            color: var(--secondary);
            font-size: 1rem;
        }

        /* Content Chambers */
        .castle-chambers {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .chamber {
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.8), rgba(101, 67, 33, 0.6));
            border: 3px solid rgba(255, 215, 0, 0.4);
            border-radius: 25px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .chamber::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: chamberGlow 6s infinite;
        }

        @keyframes chamberGlow {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        .chamber-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #ffd700;
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Nutrition Tracking Chamber */
        .food-search {
            position: relative;
            margin-bottom: 1.5rem;
            z-index: 2;
        }

        .spell-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
        }

        .spell-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .suggestion-scroll {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.9));
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .suggestion-item:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .food-details {
            flex: 1;
        }

        .food-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 0.2rem;
        }

        .food-info {
            font-size: 0.8rem;
            color: #ccc;
        }

        .quantity-controls {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            z-index: 2;
            position: relative;
        }

        .quantity-input {
            flex: 2;
            padding: 12px 15px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
        }

        .unit-select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
        }

        /* Nutrition Preview Crystal */
        .nutrition-crystal {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(20, 20, 20, 0.4));
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .crystal-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .crystal-macros {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .macro-crystal {
            text-align: center;
        }

        .macro-value {
            font-weight: bold;
            font-size: 1.2rem;
            color: #ffd700;
        }

        .macro-label {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 0.3rem;
        }

        .spell-buttons {
            display: flex;
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .spell-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Crimson Text', serif;
        }

        .spell-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .spell-btn.secondary {
            background: linear-gradient(45deg, #4b5563, #6b7280);
        }

        /* Progress Chamber */
        .progress-orb {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 2;
        }

        .calorie-orb {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--secondary) 0deg, rgba(255,255,255,0.2) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 
                0 0 30px var(--house-glow),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            transition: background 1s ease;
        }

        .orb-content {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            width: 110px;
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .orb-calories {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .orb-remaining {
            font-size: 0.8rem;
            color: #ccc;
        }

        .macro-runes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .rune {
            text-align: center;
        }

        .rune-name {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            font-weight: bold;
            color: #ffd700;
        }

        .rune-bar {
            height: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 0.5rem;
        }

        .rune-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease;
        }

        .protein-fill { 
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .carbs-fill { 
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .fat-fill { 
            background: linear-gradient(90deg, #f59e0b, #d97706);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .rune-text {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Food Log Scroll */
        .food-scroll {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .food-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            animation: entryAppear 0.6s ease;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .food-entry:hover {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            transform: translateY(-2px);
        }

        @keyframes entryAppear {
            from { opacity: 0; transform: translateY(-20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .entry-details {
            flex: 1;
        }

        .entry-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 0.3rem;
            font-size: 1.1rem;
        }

        .entry-macros {
            font-size: 0.9rem;
            color: #ccc;
        }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-rune {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .action-rune:hover {
            background: var(--secondary);
            color: var(--primary);
            transform: scale(1.1);
        }

        /* Modal Scrolls */
        .modal-scroll {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            animation: scrollFade 0.3s ease;
        }

        @keyframes scrollFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scroll-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.9));
            border: 3px solid #ffd700;
            border-radius: 25px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: scrollSlide 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        @keyframes scrollSlide {
            from { transform: translate(-50%, -60%) scale(0.9); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .scroll-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .scroll-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .close-rune {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-rune:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: rotate(90deg);
        }

        /* Toast Messages */
        .magical-toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(45deg, #4ade80, #22c55e);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border: 2px solid #16a34a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 3000;
            animation: toastSlide 0.5s ease;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .magical-toast.error {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border-color: #b91c1c;
        }

        @keyframes toastSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .castle-chambers {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .house-chamber {
                grid-template-columns: 1fr;
            }
            
            .hall-title {
                font-size: 3rem;
            }
            
            .nav-content {
                flex-direction: column;
                text-align: center;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .house-status {
                margin-top: 160px;
            }

            .quantity-controls {
                flex-direction: column;
            }

            .spell-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Magical Background -->
    <div class="castle-bg"></div>
    <div class="magical-particles"></div>

    <!-- Castle Gate Entry -->
    <div class="castle-gate" id="castleGate">
        <div class="gate-scroll">
            <h1 class="academy-title">üè∞ HOGSWORTH ACADEMY</h1>
            <p class="academy-subtitle">
                Welcome to the most prestigious academy of magical nutrition arts.<br>
                Present your entrance key or request guest passage to begin.
            </p>
            <input type="text" 
                   class="magical-input" 
                   id="entranceKey" 
                   placeholder="Enter your magical key (WIZARD123)"
                   maxlength="20">
            <button class="castle-btn" onclick="enterCastle()">üóùÔ∏è Enter the Academy</button>
            <div class="guest-link" onclick="guestEntry()">
                Request guest passage to the Great Hall
            </div>
        </div>
    </div>

    <!-- Great Hall - House Selection -->
    <div class="great-hall" id="greatHall">
        <div class="hall-header">
            <h1 class="hall-title">‚ö° HOGSWORTH ACADEMY ‚ö°</h1>
            <p class="hall-subtitle">The Great Hall of Nutritional Mastery</p>
            <p class="sorting-text">
                The ancient Sorting Chalice awaits your choice. Each house represents a path to wellness mastery. 
                Choose wisely, for your house will guide your journey to legendary health and fitness.
            </p>
        </div>
        
        <div class="house-chamber">
            <div class="house-banner serpent" onclick="joinHouse('serpent')">
                <div class="house-emblem">üêç</div>
                <h3 class="house-name">SERPENT</h3>
                <p class="house-values">Ambition ‚Ä¢ Cunning ‚Ä¢ Leadership</p>
                <p class="house-motto">"Through ambition, we achieve greatness"</p>
            </div>
            
            <div class="house-banner griffin" onclick="joinHouse('griffin')">
                <div class="house-emblem">ü¶Ö</div>
                <h3 class="house-name">GRIFFIN</h3>
                <p class="house-values">Courage ‚Ä¢ Bravery ‚Ä¢ Honor</p>
                <p class="house-motto">"Brave hearts conquer all challenges"</p>
            </div>
            
            <div class="house-banner raven" onclick="joinHouse('raven')">
                <div class="house-emblem">üê¶‚Äç‚¨õ</div>
                <h3 class="house-name">RAVEN</h3>
                <p class="house-values">Wisdom ‚Ä¢ Intelligence ‚Ä¢ Creativity</p>
                <p class="house-motto">"Knowledge illuminates the path forward"</p>
            </div>
            
            <div class="house-banner hufflecrest" onclick="joinHouse('hufflecrest')">
                <div class="house-emblem">ü¶°</div>
                <h3 class="house-name">HUFFLECREST</h3>
                <p class="house-values">Loyalty ‚Ä¢ Hard Work ‚Ä¢ Dedication</p>
                <p class="house-motto">"Through dedication, we build legends"</p>
            </div>
        </div>
    </div>

    <!-- Main Castle Interface -->
    <div class="castle-main" id="castleMain">
        <!-- Navigation Tower -->
        <div class="nav-tower">
            <div class="nav-content">
                <div class="castle-logo">üè∞ HOGSWORTH ACADEMY</div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="openScroll('goalsScroll')">üéØ Goals</button>
                    <button class="nav-btn" onclick="openScroll('chestScroll')">üèÜ Chest</button>
                    <button class="nav-btn" onclick="openScroll('weekScroll')">üìä Progress</button>
                    <button class="nav-btn" onclick="showGreatHall()">üè† Houses</button>
                    <button class="nav-btn" onclick="returnToGate()">üö™ Exit</button>
                </div>
            </div>
        </div>

        <!-- House Status Banner -->
        <div class="house-status">
            <h1 class="house-title" id="currentHouseTitle">CHOOSE YOUR HOUSE</h1>
            <p class="house-welcome" id="currentHouseWelcome">Visit the Great Hall to select your magical house</p>
            
            <div class="wizard-stats">
                <div class="stat-item">
                    <div class="stat-value" id="wizardLevel">1</div>
                    <div class="stat-label">üßô‚Äç‚ôÇÔ∏è Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="houseDisplay">None</div>
                    <div class="stat-label">üè† House</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="trophyCount">0</div>
                    <div class="stat-label">üèÜ Trophies</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">üî• Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="bestStreak">0</div>
                    <div class="stat-label">‚≠ê Best</div>
                </div>
            </div>
            
            <div class="xp-crystal">
                <div class="crystal-container">
                    <div class="crystal-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <div class="xp-text">
                    <span id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP
                </div>
            </div>
        </div>

        <!-- Castle Chambers -->
        <div class="castle-chambers">
            <!-- Nutrition Tracking Chamber -->
            <div class="chamber">
                <h2 class="chamber-title">üçé Nutrition Spellbook</h2>
                
                <div class="food-search">
                    <input type="text" 
                           class="spell-input" 
                           id="foodSpell" 
                           placeholder="Cast a food spell... (e.g., chicken, apple, oats)"
                           aria-live="polite">
                    <div class="suggestion-scroll" id="spellSuggestions"></div>
                </div>

                <div class="quantity-controls">
                    <input type="number" 
                           class="quantity-input" 
                           id="foodQuantity" 
                           placeholder="Quantity"
                           step="0.1"
                           min="0.1"
                           value="100">
                    <select class="unit-select" id="foodUnit">
                        <option value="g">grams</option>
                        <option value="oz">oz</option>
                        <option value="cup">cup</option>
                        <option value="tbsp">tbsp</option>
                        <option value="slice">slice</option>
                        <option value="piece">piece</option>
                    </select>
                </div>

                <div class="nutrition-crystal" id="nutritionCrystal" aria-live="polite">
                    <div class="crystal-title">üîÆ Nutrition Crystal</div>
                    <div class="crystal-macros">
                        <div class="macro-crystal">
                            <div class="macro-value" id="previewCals">0</div>
                            <div class="macro-label">Calories</div>
                        </div>
                        <div class="macro-crystal">
                            <div class="macro-value" id="previewProtein">0g</div>
                            <div class="macro-label">Protein</div>
                        </div>
                        <div class="macro-crystal">
                            <div class="macro-value" id="previewCarbs">0g</div>
                            <div class="macro-label">Carbs</div>
                        </div>
                        <div class="macro-crystal">
                            <div class="macro-value" id="previewFat">0g</div>
                            <div class="macro-label">Fat</div>
                        </div>
                    </div>
                </div>

                <div class="spell-buttons">
                    <button class="spell-btn" onclick="castFoodSpell()">‚ö° Cast Spell</button>
                    <button class="spell-btn secondary" onclick="openScroll('customFoodScroll')">‚ûï Create Food</button>
                </div>

                <div class="food-scroll" id="foodScroll">
                    <!-- Food entries will appear here -->
                </div>
            </div>

            <!-- Progress Tracking Chamber -->
            <div class="chamber">
                <h2 class="chamber-title">üéØ Progress Oracle</h2>
                
                <div class="progress-orb">
                    <div class="calorie-orb" id="calorieOrb">
                        <div class="orb-content">
                            <div class="orb-calories" id="orbCalories">0</div>
                            <div class="orb-remaining" id="orbRemaining">2000 left</div>
                        </div>
                    </div>
                </div>
                
                <div class="macro-runes">
                    <div class="rune">
                        <div class="rune-name">üí™ Protein</div>
                        <div class="rune-bar">
                            <div class="rune-fill protein-fill" id="proteinRune" style="width: 0%"></div>
                        </div>
                        <div class="rune-text" id="proteinText">0g / 150g</div>
                    </div>
                    
                    <div class="rune">
                        <div class="rune-name">üåæ Carbs</div>
                        <div class="rune-bar">
                            <div class="rune-fill carbs-fill" id="carbsRune" style="width: 0%"></div>
                        </div>
                        <div class="rune-text" id="carbsText">0g / 250g</div>
                    </div>
                    
                    <div class="rune">
                        <div class="rune-name">ü•ë Fat</div>
                        <div class="rune-bar">
                            <div class="rune-fill fat-fill" id="fatRune" style="width: 0%"></div>
                        </div>
                        <div class="rune-text" id="fatText">0g / 67g</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals Scroll -->
    <div class="modal-scroll" id="goalsScroll">
        <div class="scroll-content">
            <div class="scroll-header">
                <h2 class="scroll-title">üéØ Set Your Magical Goals</h2>
                <button class="close-rune" onclick="closeScroll('goalsScroll')">&times;</button>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Age:</label>
                    <input type="number" class="spell-input" id="wizardAge" value="25" style="margin-bottom: 0;">
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Gender:</label>
                    <select class="unit-select" id="wizardGender" style="width: 100%;">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Weight (kg):</label>
                    <input type="number" class="spell-input" id="wizardWeight" value="70" step="0.1" style="margin-bottom: 0;">
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Height (cm):</label>
                    <input type="number" class="spell-input" id="wizardHeight" value="175" style="margin-bottom: 0;">
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Activity Level:</label>
                    <select class="unit-select" id="activityLevel" style="width: 100%;">
                        <option value="1.2">Sedentary (little/no exercise)</option>
                        <option value="1.375">Lightly active (light exercise 1-3 days/week)</option>
                        <option value="1.55" selected>Moderately active (moderate exercise 3-5 days/week)</option>
                        <option value="1.725">Very active (hard exercise 6-7 days/week)</option>
                        <option value="1.9">Extremely active (very hard exercise/job)</option>
                    </select>
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Goal:</label>
                    <select class="unit-select" id="wizardGoal" style="width: 100%;">
                        <option value="lose">Fat Loss (-500 calories)</option>
                        <option value="maintain" selected>Maintain Weight</option>
                        <option value="gain">Muscle Gain (+300 calories)</option>
                    </select>
                </div>
                <button class="castle-btn" onclick="calculateMagicalGoals()" style="margin-top: 1rem;">‚ö° Calculate My Destiny</button>
            </div>
        </div>
    </div>

    <!-- Trophy Chest Scroll -->
    <div class="modal-scroll" id="chestScroll">
        <div class="scroll-content">
            <div class="scroll-header">
                <h2 class="scroll-title">üèÜ Trophy Vault</h2>
                <button class="close-rune" onclick="closeScroll('chestScroll')">&times;</button>
            </div>
            <div id="trophyVault" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                <!-- Trophies will populate here -->
            </div>
        </div>
    </div>

    <!-- Week Progress Scroll -->
    <div class="modal-scroll" id="weekScroll">
        <div class="scroll-content">
            <div class="scroll-header">
                <h2 class="scroll-title">üìä Weekly Chronicles</h2>
                <button class="close-rune" onclick="closeScroll('weekScroll')">&times;</button>
            </div>
            <div id="weeklyChronicles" style="text-align: center; padding: 3rem; color: #ccc;">
                üìö Your weekly nutrition chronicles will appear here as you build your magical journey. 
                Keep casting food spells to unlock detailed progress insights!
            </div>
        </div>
    </div>

    <!-- Custom Food Scroll -->
    <div class="modal-scroll" id="customFoodScroll">
        <div class="scroll-content">
            <div class="scroll-header">
                <h2 class="scroll-title">üçΩÔ∏è Create New Food Spell</h2>
                <button class="close-rune" onclick="closeScroll('customFoodScroll')">&times;</button>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Food Name:</label>
                    <input type="text" class="spell-input" id="customName" placeholder="Enter food name" style="margin-bottom: 0;">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Per Amount:</label>
                        <input type="text" class="spell-input" id="customPer" value="100g" style="margin-bottom: 0;">
                    </div>
                    <div style="flex: 1;">
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Calories:</label>
                        <input type="number" class="spell-input" id="customCals" placeholder="0" style="margin-bottom: 0;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Protein (g):</label>
                        <input type="number" class="spell-input" id="customProtein" placeholder="0" style="margin-bottom: 0;">
                    </div>
                    <div>
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Carbs (g):</label>
                        <input type="number" class="spell-input" id="customCarbs" placeholder="0" style="margin-bottom: 0;">
                    </div>
                    <div>
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Fat (g):</label>
                        <input type="number" class="spell-input" id="customFat" placeholder="0" style="margin-bottom: 0;">
                    </div>
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Aliases (comma-separated):</label>
                    <input type="text" class="spell-input" id="customAliases" placeholder="e.g., chicken breast, grilled chicken" style="margin-bottom: 0;">
                </div>
                <button class="castle-btn" onclick="createCustomFood()" style="margin-top: 1rem;">‚ú® Create Magical Food</button>
            </div>
        </div>
    </div>

    <!-- Edit Meal Scroll -->
    <div class="modal-scroll" id="editMealScroll">
        <div class="scroll-content">
            <div class="scroll-header">
                <h2 class="scroll-title">‚úèÔ∏è Edit Food Entry</h2>
                <button class="close-rune" onclick="closeScroll('editMealScroll')">&times;</button>
            </div>
            <div id="editMealName" style="text-align:center;color:#ffd700;font-size:1.4rem;margin-bottom:1.5rem;font-weight:bold;"></div>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Quantity:</label>
                    <input id="editQty" type="number" class="spell-input" step="0.1" min="0.1" style="margin-bottom: 0;">
                </div>
                <div>
                    <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Unit:</label>
                    <select id="editUnit" class="unit-select" style="width: 100%;">
                        <option value="g">grams</option>
                        <option value="oz">oz</option>
                        <option value="cup">cup</option>
                        <option value="tbsp">tbsp</option>
                        <option value="slice">slice</option>
                        <option value="piece">piece</option>
                    </select>
                </div>
                <button class="castle-btn" onclick="saveMealEdit()" style="margin-top: 1rem;">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Magical Game State
        let gameState = {
            currentHouse: '',
            level: 1,
            xp: 0,
            streak: 0,
            longestStreak: 0,
            trophies: [],
            dailyLog: [],
            goals: {
                calories: 2000,
                protein: 150,
                carbs: 250,
                fat: 67
            },
            customFoods: [],
            favoriteFoods: [],
            recentFoods: []
        };

        // Comprehensive Food Catalog
        let FOOD_CATALOG = [
            // Proteins
            { id: 'chicken_breast', name: 'Chicken Breast', cals: 165, protein: 31, carbs: 0, fat: 3.6, per: '100g', aliases: ['chicken'] },
            { id: 'salmon', name: 'Salmon', cals: 208, protein: 22, carbs: 0, fat: 12, per: '100g' },
            { id: 'tuna', name: 'Tuna', cals: 132, protein: 28, carbs: 0, fat: 1, per: '100g' },
            { id: 'eggs', name: 'Eggs', cals: 155, protein: 13, carbs: 1.1, fat: 11, per: '100g', aliases: ['egg'] },
            { id: 'greek_yogurt', name: 'Greek Yogurt', cals: 59, protein: 10, carbs: 3.6, fat: 0.4, per: '100g' },
            { id: 'cottage_cheese', name: 'Cottage Cheese', cals: 98, protein: 11, carbs: 3.4, fat: 4.3, per: '100g' },
            { id: 'lean_beef', name: 'Lean Beef', cals: 250, protein: 26, carbs: 0, fat: 15, per: '100g' },
            { id: 'turkey', name: 'Turkey', cals: 135, protein: 30, carbs: 0, fat: 1, per: '100g' },
            { id: 'tofu', name: 'Tofu', cals: 76, protein: 8, carbs: 1.9, fat: 4.8, per: '100g' },
            { id: 'shrimp', name: 'Shrimp', cals: 85, protein: 18, carbs: 0, fat: 1, per: '100g' },
            
            // Carbohydrates
            { id: 'brown_rice', name: 'Brown Rice', cals: 111, protein: 2.6, carbs: 23, fat: 0.9, per: '100g' },
            { id: 'white_rice', name: 'White Rice', cals: 130, protein: 2.7, carbs: 28, fat: 0.3, per: '100g', aliases: ['rice'] },
            { id: 'oats', name: 'Oats', cals: 389, protein: 16.9, carbs: 66, fat: 6.9, per: '100g', aliases: ['oatmeal'] },
            { id: 'quinoa', name: 'Quinoa', cals: 120, protein: 4.4, carbs: 22, fat: 1.9, per: '100g' },
            { id: 'sweet_potato', name: 'Sweet Potato', cals: 86, protein: 1.6, carbs: 20, fat: 0.1, per: '100g' },
            { id: 'potato', name: 'Potato', cals: 77, protein: 2, carbs: 17, fat: 0.1, per: '100g' },
            { id: 'pasta', name: 'Pasta', cals: 131, protein: 5, carbs: 25, fat: 1.1, per: '100g' },
            { id: 'bread', name: 'Whole Wheat Bread', cals: 247, protein: 13, carbs: 41, fat: 4, per: '100g' },
            { id: 'banana', name: 'Banana', cals: 89, protein: 1.1, carbs: 23, fat: 0.3, per: '100g' },
            { id: 'apple', name: 'Apple', cals: 52, protein: 0.3, carbs: 14, fat: 0.2, per: '100g' },
            
            // Healthy Fats
            { id: 'avocado', name: 'Avocado', cals: 160, protein: 2, carbs: 9, fat: 15, per: '100g' },
            { id: 'almonds', name: 'Almonds', cals: 579, protein: 21, carbs: 22, fat: 50, per: '100g' },
            { id: 'walnuts', name: 'Walnuts', cals: 654, protein: 15, carbs: 14, fat: 65, per: '100g' },
            { id: 'olive_oil', name: 'Olive Oil', cals: 884, protein: 0, carbs: 0, fat: 100, per: '100g' },
            { id: 'peanut_butter', name: 'Peanut Butter', cals: 588, protein: 25, carbs: 20, fat: 50, per: '100g', aliases: ['pb'] },
            { id: 'chia_seeds', name: 'Chia Seeds', cals: 486, protein: 17, carbs: 42, fat: 31, per: '100g' },
            
            // Vegetables
            { id: 'broccoli', name: 'Broccoli', cals: 34, protein: 2.8, carbs: 7, fat: 0.4, per: '100g' },
            { id: 'spinach', name: 'Spinach', cals: 23, protein: 2.9, carbs: 3.6, fat: 0.4, per: '100g' },
            { id: 'kale', name: 'Kale', cals: 35, protein: 2.9, carbs: 4.4, fat: 1.5, per: '100g' },
            { id: 'carrots', name: 'Carrots', cals: 41, protein: 0.9, carbs: 10, fat: 0.2, per: '100g' },
            { id: 'bell_peppers', name: 'Bell Peppers', cals: 20, protein: 0.9, carbs: 4.6, fat: 0.2, per: '100g' },
            
            // Fruits
            { id: 'blueberries', name: 'Blueberries', cals: 57, protein: 0.7, carbs: 14, fat: 0.3, per: '100g' },
            { id: 'strawberries', name: 'Strawberries', cals: 32, protein: 0.7, carbs: 8, fat: 0.3, per: '100g' },
            { id: 'orange', name: 'Orange', cals: 47, protein: 0.9, carbs: 12, fat: 0.1, per: '100g' },
            
            // Dairy
            { id: 'milk', name: 'Milk (2%)', cals: 50, protein: 3.3, carbs: 5, fat: 2, per: '100g' },
            { id: 'cheese', name: 'Cheddar Cheese', cals: 402, protein: 25, carbs: 1.3, fat: 33, per: '100g' },
            { id: 'yogurt', name: 'Plain Yogurt', cals: 59, protein: 10, carbs: 3.6, fat: 0.4, per: '100g' }
        ];

        // Trophy System
        const TROPHY_VAULT = {
            'first-meal': { name: 'First Feast', icon: 'üçΩÔ∏è', desc: 'Cast your first food spell', condition: () => gameState.dailyLog.length >= 1 },
            'macro-master': { name: 'Macro Wizard', icon: '‚öñÔ∏è', desc: 'Hit all macro targets in one day', condition: () => checkMacroTargets() },
            'calorie-king': { name: 'Calorie Sovereign', icon: 'üëë', desc: 'Reach your calorie goal', condition: () => getCurrentCals() >= gameState.goals.calories * 0.95 },
            'protein-power': { name: 'Protein Champion', icon: 'üí™', desc: 'Hit your protein target', condition: () => getCurrentProtein() >= gameState.goals.protein * 0.95 },
            'streak-star': { name: 'Streak Legend', icon: 'üî•', desc: 'Maintain a 7-day streak', condition: () => gameState.streak >= 7 },
            'level-legend': { name: 'Level Master', icon: 'üåü', desc: 'Reach level 10', condition: () => gameState.level >= 10 },
            'house-hero': { name: 'House Champion', icon: 'üèÜ', desc: 'Join a magical house', condition: () => gameState.currentHouse !== '' },
            'nutrition-ninja': { name: 'Nutrition Sage', icon: 'ü•∑', desc: 'Log 100 meals', condition: () => getTotalMealsLogged() >= 100 },
            'custom-creator': { name: 'Food Alchemist', icon: 'üß™', desc: 'Create 5 custom foods', condition: () => gameState.customFoods.length >= 5 },
            'favorite-master': { name: 'Favorite Collector', icon: '‚≠ê', desc: 'Add 10 favorite foods', condition: () => gameState.favoriteFoods.length >= 10 },
            'dedication-badge': { name: 'Dedication Medal', icon: 'üèÖ', desc: 'Use the app for 30 days', condition: () => false }, // Placeholder
            'ultimate-wizard': { name: 'Ultimate Nutrition Wizard', icon: 'üßô‚Äç‚ôÇÔ∏è', desc: 'Unlock all other trophies', condition: () => gameState.trophies.length >= 10 }
        };

        // Unit Conversions
        const UNIT_CONVERSIONS = {
            'g': 1,
            'oz': 28.35,
            'cup': 240,
            'tbsp': 15,
            'slice': 30,
            'piece': 50
        };

        // Global Variables
        let selectedFood = null;
        let editingMealId = null;

        // Utility Functions
        const debounce = (fn, ms = 200) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), ms);
            };
        };

        const iso = (date = new Date()) => date.toISOString().slice(0, 10);

        // Initialize App
        function init() {
            createMagicalParticles();
            setupFoodSpellSearch();
            loadGameState();
            
            // Enter key support for entrance
            document.getElementById('entranceKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enterCastle();
            });
        }

        // Create Magical Particles
        function createMagicalParticles() {
            const particleContainer = document.querySelector('.magical-particles');
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particleContainer.appendChild(particle);
            }
        }

        // Enhanced Food Search System
        function setupFoodSpellSearch() {
            const input = document.getElementById('foodSpell');
            const suggestions = document.getElementById('spellSuggestions');
            const quantity = document.getElementById('foodQuantity');
            const unit = document.getElementById('foodUnit');
            
            input.addEventListener('input', debounce(function() {
                const query = input.value.toLowerCase().trim();
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }
                showFoodSuggestions(query);
            }));
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && selectedFood) {
                    castFoodSpell();
                }
            });
            
            quantity.addEventListener('input', updateNutritionPreview);
            unit.addEventListener('change', updateNutritionPreview);
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        function showFoodSuggestions(query) {
            const suggestions = document.getElementById('spellSuggestions');
            
            // Priority: Favorites -> Recent -> All foods
            const favorites = gameState.favoriteFoods.map(id => FOOD_CATALOG.find(f => f.id === id)).filter(Boolean);
            const recents = gameState.recentFoods.map(id => FOOD_CATALOG.find(f => f.id === id)).filter(Boolean);
            
            const orderedFoods = [
                ...favorites.filter(food => matchesQuery(food, query)),
                ...recents.filter(food => matchesQuery(food, query) && !favorites.some(f => f.id === food.id)),
                ...FOOD_CATALOG.filter(food => matchesQuery(food, query) && 
                    !favorites.some(f => f.id === food.id) && !recents.some(r => r.id === food.id))
            ];
            
            const results = orderedFoods.slice(0, 8);
            
            if (results.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            suggestions.innerHTML = results.map(food => `
                <div class="suggestion-item">
                    <div class="food-details" onclick="selectFood('${food.id}')">
                        <div class="food-name">${food.name} ${isFavorite(food.id) ? '‚≠ê' : ''}</div>
                        <div class="food-info">${food.cals} cal ‚Ä¢ ${food.protein}p ‚Ä¢ ${food.carbs}c ‚Ä¢ ${food.fat}f per ${food.per}</div>
                    </div>
                    <div>
                        <button class="action-rune" onclick="event.stopPropagation(); toggleFavorite('${food.id}'); updateFoodSuggestions();">${isFavorite(food.id) ? '‚òÖ' : '‚òÜ'}</button>
                    </div>
                </div>
            `).join('');
            
            suggestions.style.display = 'block';
        }

        function matchesQuery(food, query) {
            const searchTerms = [food.name.toLowerCase(), ...(food.aliases || [])];
            return searchTerms.some(term => term.includes(query));
        }

        function selectFood(foodId) {
            selectedFood = FOOD_CATALOG.find(f => f.id === foodId);
            if (selectedFood) {
                document.getElementById('foodSpell').value = selectedFood.name;
                document.getElementById('spellSuggestions').style.display = 'none';
                updateNutritionPreview();
                addToRecents(foodId);
            }
        }

        function updateFoodSuggestions() {
            const query = document.getElementById('foodSpell').value.toLowerCase().trim();
            if (query.length >= 2) {
                showFoodSuggestions(query);
            }
        }

        function addToRecents(foodId) {
            gameState.recentFoods = gameState.recentFoods.filter(id => id !== foodId);
            gameState.recentFoods.unshift(foodId);
            gameState.recentFoods = gameState.recentFoods.slice(0, 10);
            saveGameState();
        }

        function toggleFavorite(foodId) {
            const index = gameState.favoriteFoods.indexOf(foodId);
            if (index > -1) {
                gameState.favoriteFoods.splice(index, 1);
            } else {
                gameState.favoriteFoods.unshift(foodId);
                gameState.favoriteFoods = gameState.favoriteFoods.slice(0, 50);
            }
            saveGameState();
            checkTrophies();
        }

        function isFavorite(foodId) {
            return gameState.favoriteFoods.includes(foodId);
        }

        function updateNutritionPreview() {
            if (!selectedFood) {
                resetNutritionPreview();
                return;
            }
            
            const quantity = parseFloat(document.getElementById('foodQuantity').value) || 0;
            const unit = document.getElementById('foodUnit').value;
            
            if (quantity <= 0) {
                resetNutritionPreview();
                return;
            }
            
            const nutrition = calculateNutrition(selectedFood, quantity, unit);
            
            document.getElementById('previewCals').textContent = Math.round(nutrition.calories);
            document.getElementById('previewProtein').textContent = nutrition.protein.toFixed(1) + 'g';
            document.getElementById('previewCarbs').textContent = nutrition.carbs.toFixed(1) + 'g';
            document.getElementById('previewFat').textContent = nutrition.fat.toFixed(1) + 'g';
        }

        function resetNutritionPreview() {
            document.getElementById('previewCals').textContent = '0';
            document.getElementById('previewProtein').textContent = '0g';
            document.getElementById('previewCarbs').textContent = '0g';
            document.getElementById('previewFat').textContent = '0g';
        }

        function calculateNutrition(food, quantity, unit) {
            const gramsAmount = quantity * UNIT_CONVERSIONS[unit];
            const multiplier = gramsAmount / 100;
            
            return {
                calories: food.cals * multiplier,
                protein: food.protein * multiplier,
                carbs: food.carbs * multiplier,
                fat: food.fat * multiplier
            };
        }

        // Entry System
        function enterCastle() {
            const key = document.getElementById('entranceKey').value.trim().toUpperCase();
            const validKeys = ['WIZARD123', 'MAGIC', 'ACADEMY', 'STUDENT', 'HOGSWORTH'];
            
            if (validKeys.includes(key) || key === '') {
                showMagicalToast('Welcome to Hogsworth Academy! üè∞‚ú®', 'success');
                setTimeout(() => {
                    document.getElementById('castleGate').style.display = 'none';
                    document.getElementById('greatHall').style.display = 'flex';
                }, 1200);
            } else {
                showMagicalToast('Invalid magical key! Try WIZARD123 or request guest passage.', 'error');
                const input = document.getElementById('entranceKey');
                input.style.animation = 'shake 0.5s ease';
                setTimeout(() => input.style.animation = '', 500);
            }
        }

        function guestEntry() {
            showMagicalToast('Welcome, honored guest! üéì', 'success');
            setTimeout(() => {
                document.getElementById('castleGate').style.display = 'none';
                document.getElementById('greatHall').style.display = 'flex';
            }, 1200);
        }

        function returnToGate() {
            document.getElementById('castleMain').style.display = 'none';
            document.getElementById('greatHall').style.display = 'none';
            document.getElementById('castleGate').style.display = 'flex';
            showMagicalToast('Thank you for visiting Hogsworth Academy! üè∞', 'success');
        }

        function showGreatHall() {
            document.getElementById('castleMain').style.display = 'none';
            document.getElementById('greatHall').style.display = 'flex';
        }

        // House System
        function joinHouse(house) {
            gameState.currentHouse = house;
            document.body.className = house;
            
            awardTrophy('house-hero');
            updateHouseDisplay();
            
            showMagicalToast(`Welcome to ${house.charAt(0).toUpperCase() + house.slice(1)} House! üèÜ`, 'success');
            
            setTimeout(() => {
                document.getElementById('greatHall').style.display = 'none';
                document.getElementById('castleMain').style.display = 'block';
                updateAllDisplays();
            }, 1500);
            
            saveGameState();
        }

        function updateHouseDisplay() {
            const houseNames = {
                'serpent': 'SERPENT HOUSE',
                'griffin': 'GRIFFIN HOUSE',
                'raven': 'RAVEN HOUSE',
                'hufflecrest': 'HUFFLECREST HOUSE'
            };
            
            const houseWelcomes = {
                'serpent': 'Through ambition and cunning, we master nutrition üêç',
                'griffin': 'With courage and honor, we conquer our fitness goals ü¶Ö',
                'raven': 'Through wisdom and knowledge, we unlock optimal health üê¶‚Äç‚¨õ',
                'hufflecrest': 'With dedication and loyalty, we build lasting wellness ü¶°'
            };
            
            document.getElementById('currentHouseTitle').textContent = houseNames[gameState.currentHouse] || 'CHOOSE YOUR HOUSE';
            document.getElementById('currentHouseWelcome').textContent = houseWelcomes[gameState.currentHouse] || 'Visit the Great Hall to select your magical house';
            document.getElementById('houseDisplay').textContent = gameState.currentHouse.charAt(0).toUpperCase() + gameState.currentHouse.slice(1) || 'None';
        }

        // Food Tracking
        function castFoodSpell() {
            if (!selectedFood) {
                showMagicalToast('Please select a food from the spellbook first! üìö', 'error');
                return;
            }
            
            const quantity = parseFloat(document.getElementById('foodQuantity').value) || 0;
            const unit = document.getElementById('foodUnit').value;
            
            if (quantity <= 0) {
                showMagicalToast('Please enter a valid quantity! ‚öñÔ∏è', 'error');
                return;
            }
            
            const nutrition = calculateNutrition(selectedFood, quantity, unit);
            
            const foodEntry = {
                id: Date.now(),
                foodId: selectedFood.id,
                name: selectedFood.name,
                quantity: quantity,
                unit: unit,
                nutrition: nutrition,
                timestamp: new Date().toISOString(),
                date: iso()
            };
            
            gameState.dailyLog.push(foodEntry);
            addXP(15);
            checkTrophies();
            
            // Clear inputs
            document.getElementById('foodSpell').value = '';
            document.getElementById('foodQuantity').value = '100';
            document.getElementById('foodUnit').value = 'g';
            selectedFood = null;
            resetNutritionPreview();
            
            updateAllDisplays();
            showMagicalToast(`${foodEntry.name} spell cast successfully! +15 XP ‚ö°`, 'success');
            saveGameState();
        }

        // Display Updates
        function updateAllDisplays() {
            updateWizardStats();
            updateProgressDisplay();
            updateFoodLog();
        }

        function updateWizardStats() {
            document.getElementById('wizardLevel').textContent = gameState.level;
            document.getElementById('trophyCount').textContent = gameState.trophies.length;
            document.getElementById('currentStreak').textContent = gameState.streak;
            document.getElementById('bestStreak').textContent = gameState.longestStreak;
            
            // Update XP Crystal
            const xpNeeded = gameState.level * 100;
            const xpProgress = (gameState.xp / xpNeeded) * 100;
            document.getElementById('xpFill').style.width = xpProgress + '%';
            document.getElementById('currentXP').textContent = gameState.xp;
            document.getElementById('nextLevelXP').textContent = xpNeeded;
        }

        function updateProgressDisplay() {
            const currentCals = getCurrentCals();
            const currentProtein = getCurrentProtein();
            const currentCarbs = getCurrentCarbs();
            const currentFat = getCurrentFat();
            
            // Update Calorie Orb
            const calorieProgress = Math.min(currentCals / gameState.goals.calories, 1);
            document.getElementById('calorieOrb').style.background = 
                `conic-gradient(var(--secondary) ${calorieProgress * 360}deg, rgba(255,255,255,0.2) 0deg)`;
            
            document.getElementById('orbCalories').textContent = Math.round(currentCals);
            document.getElementById('orbRemaining').textContent = Math.max(0, Math.round(gameState.goals.calories - currentCals)) + ' left';
            
            // Update Macro Runes
            const proteinProgress = Math.min((currentProtein / gameState.goals.protein) * 100, 100);
            const carbsProgress = Math.min((currentCarbs / gameState.goals.carbs) * 100, 100);
            const fatProgress = Math.min((currentFat / gameState.goals.fat) * 100, 100);
            
            document.getElementById('proteinRune').style.width = proteinProgress + '%';
            document.getElementById('carbsRune').style.width = carbsProgress + '%';
            document.getElementById('fatRune').style.width = fatProgress + '%';
            
            document.getElementById('proteinText').textContent = `${Math.round(currentProtein)}g / ${gameState.goals.protein}g`;
            document.getElementById('carbsText').textContent = `${Math.round(currentCarbs)}g / ${gameState.goals.carbs}g`;
            document.getElementById('fatText').textContent = `${Math.round(currentFat)}g / ${gameState.goals.fat}g`;
        }

        function updateFoodLog() {
            const foodScroll = document.getElementById('foodScroll');
            const todaysFood = getTodaysFood().reverse();
            
            if (todaysFood.length === 0) {
                foodScroll.innerHTML = '<div style="text-align: center; color: #ccc; padding: 2rem;">No food spells cast today. Begin your magical nutrition journey! ‚ú®</div>';
                return;
            }
            
            foodScroll.innerHTML = todaysFood.map(food => `
                <div class="food-entry">
                    <div class="entry-details">
                        <div class="entry-name">${food.name} (${food.quantity}${food.unit})</div>
                        <div class="entry-macros">${Math.round(food.nutrition.calories)} cal ‚Ä¢ ${food.nutrition.protein.toFixed(1)}g protein ‚Ä¢ ${food.nutrition.carbs.toFixed(1)}g carbs ‚Ä¢ ${food.nutrition.fat.toFixed(1)}g fat</div>
                    </div>
                    <div class="entry-actions">
                        <button class="action-rune" onclick="editMeal(${food.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="action-rune" onclick="deleteMeal(${food.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Calculation Functions
        function getCurrentCals() {
            return getTodaysFood().reduce((total, food) => total + food.nutrition.calories, 0);
        }

        function getCurrentProtein() {
            return getTodaysFood().reduce((total, food) => total + food.nutrition.protein, 0);
        }

        function getCurrentCarbs() {
            return getTodaysFood().reduce((total, food) => total + food.nutrition.carbs, 0);
        }

        function getCurrentFat() {
            return getTodaysFood().reduce((total, food) => total + food.nutrition.fat, 0);
        }

        function getTodaysFood() {
            const today = iso();
            return gameState.dailyLog.filter(food => food.date === today);
        }

        function getTotalMealsLogged() {
            return gameState.dailyLog.length;
        }

        // Meal Management
        let currentEditingMeal = null;

        function editMeal(mealId) {
            const meal = gameState.dailyLog.find(m => m.id === mealId);
            if (!meal) return;
            
            currentEditingMeal = meal;
            document.getElementById('editMealName').textContent = meal.name;
            document.getElementById('editQty').value = meal.quantity;
            document.getElementById('editUnit').value = meal.unit;
            
            openScroll('editMealScroll');
        }

        function saveMealEdit() {
            if (!currentEditingMeal) return;
            
            const newQuantity = parseFloat(document.getElementById('editQty').value) || currentEditingMeal.quantity;
            const newUnit = document.getElementById('editUnit').value || currentEditingMeal.unit;
            
            const food = FOOD_CATALOG.find(f => f.id === currentEditingMeal.foodId);
            if (!food) return;
            
            const newNutrition = calculateNutrition(food, newQuantity, newUnit);
            
            const mealIndex = gameState.dailyLog.findIndex(m => m.id === currentEditingMeal.id);
            gameState.dailyLog[mealIndex] = {
                ...currentEditingMeal,
                quantity: newQuantity,
                unit: newUnit,
                nutrition: newNutrition
            };
            
            updateAllDisplays();
            closeScroll('editMealScroll');
            showMagicalToast('Meal updated successfully! ‚ú®', 'success');
            currentEditingMeal = null;
            saveGameState();
        }

        function deleteMeal(mealId) {
            const mealIndex = gameState.dailyLog.findIndex(m => m.id === mealId);
            if (mealIndex === -1) return;
            
            const meal = gameState.dailyLog[mealIndex];
            gameState.dailyLog.splice(mealIndex, 1);
            
            updateAllDisplays();
            showMagicalToast(`${meal.name} removed from log`, 'success');
            saveGameState();
        }

        // Custom Food Creation
        function createCustomFood() {
            const name = document.getElementById('customName').value.trim();
            const per = document.getElementById('customPer').value.trim() || '100g';
            const cals = parseFloat(document.getElementById('customCals').value) || 0;
            const protein = parseFloat(document.getElementById('customProtein').value) || 0;
            const carbs = parseFloat(document.getElementById('customCarbs').value) || 0;
            const fat = parseFloat(document.getElementById('customFat').value) || 0;
            const aliasStr = document.getElementById('customAliases').value || '';
            const aliases = aliasStr.split(',').map(s => s.trim()).filter(Boolean);
            
            if (!name) {
                showMagicalToast('Please enter a food name! üìù', 'error');
                return;
            }
            
            const customFood = {
                id: 'custom_' + Date.now(),
                name,
                per,
                cals,
                protein,
                carbs,
                fat,
                aliases
            };
            
            gameState.customFoods.push(customFood);
            FOOD_CATALOG.push(customFood);
            
            // Clear form
            document.getElementById('customName').value = '';
            document.getElementById('customPer').value = '100g';
            document.getElementById('customCals').value = '';
            document.getElementById('customProtein').value = '';
            document.getElementById('customCarbs').value = '';
            document.getElementById('customFat').value =
