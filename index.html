<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyrnwick Academy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Magical Background Effects */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Harry Potter House Themes */
        .viperthorn { 
            --primary: #1a4d2e; 
            --secondary: #c0c0c0; 
            --accent: #2d5a3d;
            --house-main: #1a4d2e;
            --house-accent: #c0c0c0;
        }
        .braverun { 
            --primary: #740001; 
            --secondary: #ffd700; 
            --accent: #ae0001;
            --house-main: #740001;
            --house-accent: #ffd700;
        }
        .nightwing { 
            --primary: #0e1a40; 
            --secondary: #946b2d; 
            --accent: #222f5b;
            --house-main: #0e1a40;
            --house-accent: #946b2d;
        }
        .cinderglen { 
            --primary: #ecb939; 
            --secondary: #372e29; 
            --accent: #f0c75e;
            --house-main: #ecb939;
            --house-accent: #372e29;
        }

        /* Student Key Gate */
        .key-gate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .admission-letter {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.5);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-width: 500px;
        }

        .admission-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .admission-text {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .skip-link {
            color: rgba(255,215,0,0.7);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        /* Welcome Page Styles */
        .welcome-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .academy-logo {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .academy-subtitle {
            font-size: 1.4rem;
            font-style: italic;
            color: #ffd700;
            margin-bottom: 3rem;
            text-align: center;
        }

        .house-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
        }

        .house-crest {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .house-crest.viperthorn {
            border-color: #1a4d2e;
            background: linear-gradient(145deg, rgba(26,77,46,0.2), rgba(26,77,46,0.1));
        }

        .house-crest.braverun {
            border-color: #740001;
            background: linear-gradient(145deg, rgba(116,0,1,0.2), rgba(116,0,1,0.1));
        }

        .house-crest.nightwing {
            border-color: #0e1a40;
            background: linear-gradient(145deg, rgba(14,26,64,0.2), rgba(14,26,64,0.1));
        }

        .house-crest.cinderglen {
            border-color: #ecb939;
            background: linear-gradient(145deg, rgba(236,185,57,0.2), rgba(236,185,57,0.1));
        }

        .house-crest::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
            transform: rotate(-45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .house-crest:hover::before {
            opacity: 1;
            transform: rotate(-45deg) translate(50%, 50%);
        }

        .house-crest:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .house-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
        }

        .house-character {
            font-size: 5rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            transition: transform 0.3s ease;
        }

        .house-crest:hover .house-character {
            transform: scale(1.1);
        }

        .house-name {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .house-crest.viperthorn .house-name { color: #c0c0c0; }
        .house-crest.braverun .house-name { color: #ffd700; }
        .house-crest.nightwing .house-name { color: #946b2d; }
        .house-crest.cinderglen .house-name { color: #372e29; }

        .house-motto {
            font-style: italic;
            color: #ccc;
            font-size: 1rem;
        }

        /* Tracker Page Styles */
        .tracker-page {
            display: none;
            padding: 2rem;
            position: relative;
            z-index: 10;
        }

        .tracker-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 20px;
            border: 3px solid var(--secondary);
            position: relative;
        }

        .tracker-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .house-welcome {
            font-size: 1.2rem;
            color: #fff;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .character-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.9rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        .streak-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 1rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .customize-btn, .goals-btn, .week-btn, .chest-btn {
            position: absolute;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .customize-btn { top: 1rem; right: 1rem; }
        .goals-btn { top: 1rem; left: 1rem; }
        .week-btn { top: 3rem; right: 1rem; }
        .chest-btn { top: 3rem; left: 1rem; }

        /* XP Bar */
        .xp-container {
            margin: 1rem 0;
        }

        .xp-bar {
            height: 25px;
            background: linear-gradient(90deg, #000, #333);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--secondary);
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9333ea, #c084fc, #e879f9);
            transition: width 0.8s ease;
            border-radius: 12px;
            position: relative;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-text {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: bold;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .tracker-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .magical-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
        }

        .magical-input, .magical-select {
            padding: 12px 15px;
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
        }

        .magical-input {
            width: 100%;
        }

        .magical-select {
            min-width: 80px;
        }

        .magical-input:focus, .magical-select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }

        .magical-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            font-family: 'Crimson Text', serif;
        }

        .magical-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .magical-btn.secondary {
            background: linear-gradient(45deg, #4b5563, #6b7280);
        }

        /* Nutrition Preview */
        .nutrition-preview {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 1rem 0;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Goals & Macros */
        .goals-container {
            margin: 2rem 0;
        }

        .calorie-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
        }

        .ring-bg, .ring-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid;
        }

        .ring-bg {
            border-color: rgba(255,255,255,0.2);
        }

        .ring-fill {
            border-color: var(--secondary);
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(-90deg);
            transition: transform 0.8s ease;
        }

        .ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .ring-calories {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .ring-remaining {
            font-size: 0.8rem;
            color: #ccc;
        }

        .macro-bars {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .macro-bar {
            text-align: center;
        }

        .macro-name {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .macro-progress {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .macro-fill {
            height: 100%;
            transition: width 0.8s ease;
            border-radius: 4px;
        }

        .protein-fill { background: #ef4444; }
        .carbs-fill { background: #3b82f6; }
        .fat-fill { background: #f59e0b; }

        .macro-text {
            font-size: 0.7rem;
            color: #ccc;
        }

        /* Food Log */
        .food-log {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            animation: foodAppear 0.5s ease;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .food-item:hover {
            background: rgba(255,215,0,0.2);
        }

        @keyframes foodAppear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .food-details {
            flex: 1;
        }

        .food-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .food-macros {
            font-size: 0.8rem;
            color: #ccc;
        }

        .food-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255,215,0,0.2);
        }

        /* Weekly Challenges */
        .challenge-list {
            margin-top: 1rem;
        }

        .challenge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .challenge-item.completed {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border-color: var(--secondary);
        }

        .challenge-text {
            font-weight: bold;
        }

        .challenge-reward {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        /* House Tournament */
        .leaderboard {
            margin-top: 1rem;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
        }

        .leaderboard-item.champion {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border-color: #ffd700;
            font-weight: bold;
        }

        .house-position {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-number {
            font-size: 1.2rem;
            font-weight: bold;
            width: 30px;
        }

        /* Wizard Chest (Trophy Case) */
        .chest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .trophy {
            text-align: center;
            padding: 1rem;
            background: rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .trophy.earned {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border-color: var(--secondary);
            animation: trophyGlow 3s infinite;
        }

        .trophy.newly-earned {
            animation: trophySparkle 1.5s ease;
        }

        @keyframes trophyGlow {
            0%, 100% { box-shadow: 0 0 15px var(--secondary); }
            50% { box-shadow: 0 0 25px var(--secondary); }
        }

        @keyframes trophySparkle {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1); }
        }

        .trophy-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .trophy-name {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .trophy-desc {
            font-size: 0.7rem;
            color: #ccc;
            margin-top: 0.3rem;
        }

        /* Auto-suggest dropdown */
        .suggest-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggest-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(255,215,0,0.1);
        }

        .suggest-item:hover {
            background: rgba(255,215,0,0.2);
        }

        .suggest-food-name {
            font-weight: bold;
        }

        .suggest-food-info {
            font-size: 0.8rem;
            color: #ccc;
        }

        .input-container {
            position: relative;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.5);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(10px);
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 2rem;
        }

        .customization-section {
            margin-bottom: 2rem;
            text-align: left;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .option-btn {
            padding: 1rem;
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .option-btn.selected {
            border-color: var(--secondary);
            background: linear-gradient(45deg, var(--primary), var(--accent));
        }

        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
        }

        /* Goals Modal */
        .goals-form {
            text-align: left;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary);
            font-weight: bold;
        }

        /* Week View */
        .week-view {
            margin-top: 2rem;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .day-card {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .day-name {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 0.5rem;
        }

        .day-calories {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .day-net {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Potion Brewing Styles */
        .brewing-stage {
            text-align: center;
            margin: 2rem 0;
        }

        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .ingredient-btn {
            padding: 1rem;
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .ingredient-btn:hover {
            border-color: var(--secondary);
            background: rgba(255,215,0,0.1);
        }

        .stir-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border: 3px solid var(--secondary);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .stir-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--secondary);
        }

        .potion-result {
            margin: 2rem 0;
            padding: 1rem;
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
        }

        /* Study Hall Meditation */
        .meditation-container {
            text-align: center;
            padding: 2rem;
        }

        .breathing-orb {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--secondary), var(--primary));
            margin: 2rem auto;
            animation: breathe 4s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .meditation-timer {
            font-size: 2rem;
            color: var(--secondary);
            margin: 1rem 0;
        }

        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 10px;
            border: 1px solid var(--secondary);
            z-index: 1001;
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .academy-logo {
                font-size: 2.5rem;
            }
            
            .house-selection {
                grid-template-columns: 1fr;
            }
            
            .tracker-content {
                grid-template-columns: 1fr;
            }

            .character-info, .streak-info {
                flex-direction: column;
                gap: 0.5rem;
            }

            .input-row {
                flex-direction: column;
            }

            .macro-bars {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .week-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations */
        @keyframes manaGain {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        .mana-gained {
            position: fixed;
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 1000;
            animation: manaGain 1s ease-out forwards;
        }

        @keyframes levelUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.5); }
            100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
        }

        .level-up {
            position: fixed;
            color: #9333ea;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 1000;
            animation: levelUp 2s ease-out forwards;
        }

        @keyframes xpGain {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.1); opacity: 0; }
        }

        .xp-gained {
            position: fixed;
            color: #9333ea;
            font-weight: bold;
            font-size: 1rem;
            pointer-events: none;
            z-index: 1000;
            animation: xpGain 1s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <!-- Student Key Gate -->
    <div class="key-gate" id="keyGate">
        <div class="admission-letter">
            <h1 class="admission-title">üè∞ Wyrnwick Academy</h1>
            <p class="admission-text">
                Dear Student,<br><br>
                You have been selected to join our prestigious academy of magical wellness. 
                Please present your admission key to begin your journey.
            </p>
            <input type="text" id="studentKey" class="key-input magical-input" placeholder="Enter your Student Key">
            <button class="magical-btn" onclick="checkStudentKey()">üîÆ Enter Academy</button>
            <div class="skip-link" onclick="skipKeyCheck()">Continue as Guest Student</div>
        </div>
    </div>

    <!-- Welcome/House Selection Page -->
    <div class="welcome-page" id="welcomePage">
        <h1 class="academy-logo">WYRNWICK ACADEMY</h1>
        <p class="academy-subtitle">Begin your magical wellness journey</p>
        
        <div class="house-selection">
            <div class="house-crest viperthorn" onclick="selectHouse('viperthorn')">
                <div class="house-icon">
                    <div class="house-character">üêç</div>
                </div>
                <div class="house-name">VIPERTHORN</div>
                <div class="house-motto">"Cunning guides the wise"</div>
            </div>
            
            <div class="house-crest braverun" onclick="selectHouse('braverun')">
                <div class="house-icon">
                    <div class="house-character">ü¶Å</div>
                </div>
                <div class="house-name">BRAVERUN</div>
                <div class="house-motto">"Courage conquers all"</div>
            </div>
            
            <div class="house-crest nightwing" onclick="selectHouse('nightwing')">
                <div class="house-icon">
                    <div class="house-character">ü¶Ö</div>
                </div>
                <div class="house-name">NIGHTWING</div>
                <div class="house-motto">"Wisdom illuminates darkness"</div>
            </div>
            
            <div class="house-crest cinderglen" onclick="selectHouse('cinderglen')">
                <div class="house-icon">
                    <div class="house-character">ü¶°</div>
                </div>
                <div class="house-name">CINDERGLEN</div>
                <div class="house-motto">"Loyalty burns eternal"</div>
            </div>
        </div>
    </div>

    <!-- Character Customization Modal -->
    <div class="modal" id="customizeModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeCustomizeModal()">√ó</button>
            <h2 class="modal-title">‚ö° Character Customization</h2>
            
            <div class="customization-section">
                <h3 class="section-title">ü™Ñ Choose Your Wand</h3>
                <div class="option-grid">
                    <div class="option-btn" onclick="selectOption('wand', 'phoenix')" id="wand-phoenix">
                        üî• Phoenix Core
                    </div>
                    <div class="option-btn" onclick="selectOption('wand', 'dragon')" id="wand-dragon">
                        üêâ Dragon Heartstring
                    </div>
                    <div class="option-btn" onclick="selectOption('wand', 'unicorn')" id="wand-unicorn">
                        ü¶Ñ Unicorn Hair
                    </div>
                </div>
            </div>

            <div class="customization-section">
                <h3 class="section-title">üêæ Choose Your Companion</h3>
                <div class="option-grid">
                    <div class="option-btn" onclick="selectOption('companion', 'owl')" id="companion-owl">
                        ü¶â Wise Owl
                    </div>
                    <div class="option-btn" onclick="selectOption('companion', 'cat')" id="companion-cat">
                        üê± Shadow Cat
                    </div>
                    <div class="option-btn" onclick="selectOption('companion', 'toad')" id="companion-toad">
                        üê∏ Ancient Toad
                    </div>
                </div>
            </div>

            <div class="customization-section">
                <h3 class="section-title">üëë Choose Your Background</h3>
                <div class="option-grid">
                    <div class="option-btn" onclick="selectOption('background', 'royal')" id="background-royal">
                        üëë Royal Bloodline
                    </div>
                    <div class="option-btn" onclick="selectOption('background', 'forest')" id="background-forest">
                        üå≤ Forest Folk
                    </div>
                    <div class="option-btn" onclick="selectOption('background', 'shadow')" id="background-shadow">
                        üåô Shadow Walker
                    </div>
                </div>
            </div>

            <button class="magical-btn" onclick="saveCustomization()">‚ú® Save Character</button>
        </div>
    </div>

    <!-- Goals Modal -->
    <div class="modal" id="goalsModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeGoalsModal()">√ó</button>
            <h2 class="modal-title">üéØ Set Your Goals</h2>
            
            <div class="goals-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sex</label>
                        <select id="profileSex" class="magical-select" style="width: 100%;">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" id="profileAge" class="magical-input" value="25" min="13" max="120">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Height (cm)</label>
                        <input type="number" id="profileHeight" class="magical-input" value="175" min="100" max="250">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" id="profileWeight" class="magical-input" value="70" min="30" max="300">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Activity Level</label>
                    <select id="profileActivity" class="magical-select" style="width: 100%;">
                        <option value="sedentary">Sedentary (little/no exercise)</option>
                        <option value="light">Light (1-3 days/week)</option>
                        <option value="moderate">Moderate (3-5 days/week)</option>
                        <option value="active">Active (6-7 days/week)</option>
                        <option value="very_active">Very Active (2x/day, intense)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Goal</label>
                    <select id="profileGoal" class="magical-select" style="width: 100%;">
                        <option value="fat_loss">Fat Loss (-500 cal/day)</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="muscle_gain">Muscle Gain (+300 cal/day)</option>
                    </select>
                </div>

                <div id="calculatedGoals" style="margin: 2rem 0; padding: 1rem; background: rgba(255,215,0,0.1); border-radius: 8px; display: none;">
                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">Calculated Targets:</h4>
                    <div id="goalsDisplay"></div>
                </div>
            </div>

            <button class="magical-btn" onclick="calculateGoals()">üìä Calculate Goals</button>
            <button class="magical-btn" onclick="saveGoals()" style="margin-top: 0.5rem;">‚ú® Save Goals</button>
        </div>
    </div>

    <!-- Week View Modal -->
    <div class="modal" id="weekModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeWeekModal()">√ó</button>
            <h2 class="modal-title">üìä Week Overview</h2>
            
            <div class="week-view">
                <div class="week-grid" id="weekGrid"></div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-top: 2rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);" id="weekAvgCalories">0</div>
                        <div style="color: #ccc;">Avg Calories</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;" id="weekAvgProtein">0</div>
                        <div style="color: #ccc;">Avg Protein</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);" id="weekStreak">0</div>
                        <div style="color: #ccc;">Current Streak</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wizard Chest Modal -->
    <div class="modal" id="chestModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeChestModal()">√ó</button>
            <h2 class="modal-title">üèÜ Wizard's Trophy Chest</h2>
            
            <div class="chest-grid" id="chestGrid"></div>
        </div>
    </div>

    <!-- Potion Brewing Modal -->
    <div class="modal" id="potionModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closePotionModal()">√ó</button>
            <h2 class="modal-title">üß™ Potion Brewing</h2>
            
            <div id="brewingStage1" class="brewing-stage">
                <h3 class="section-title">Step 1: Choose Your Ingredient</h3>
                <div class="ingredient-grid">
                    <div class="ingredient-btn" onclick="selectIngredient('apple')">üçé Apple</div>
                    <div class="ingredient-btn" onclick="selectIngredient('cheese')">üßÄ Cheese</div>
                    <div class="ingredient-btn" onclick="selectIngredient('egg')">ü•ö Egg</div>
                    <div class="ingredient-btn" onclick="selectIngredient('honey')">üçØ Honey</div>
                    <div class="ingredient-btn" onclick="selectIngredient('mushroom')">üçÑ Mushroom</div>
                    <div class="ingredient-btn" onclick="selectIngredient('crystal')">üíé Crystal</div>
                </div>
            </div>

            <div id="brewingStage2" class="brewing-stage" style="display: none;">
                <h3 class="section-title">Step 2: Choose Your Rune Boost</h3>
                <div class="option-grid">
                    <div class="option-btn" onclick="selectBoost('speed')">‚ö° Speed Boost</div>
                    <div class="option-btn" onclick="selectBoost('mana')">üíô Mana Regen</div>
                    <div class="option-btn" onclick="selectBoost('xp')">‚ú® XP Boost</div>
                </div>
            </div>

            <div id="brewingStage3" class="brewing-stage" style="display: none;">
                <h3 class="section-title">Step 3: Stir the Cauldron</h3>
                <div class="stir-button" onclick="stirPotion()">
                    üåÄ<br>STIR
                </div>
            </div>

            <div id="potionResult" class="potion-result" style="display: none;">
                <h3 class="section-title">Potion Complete!</h3>
                <div id="potionResultText"></div>
                <button class="magical-btn" onclick="closePotionModal()">Collect Reward</button>
            </div>
        </div>
    </div>

    <!-- Study Hall Modal -->
    <div class="modal" id="studyModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeStudyModal()">√ó</button>
            <h2 class="modal-title">üìö Study Hall Meditation</h2>
            
            <div class="meditation-container">
                <p style="margin-bottom: 2rem;">Focus on the breathing orb and find your inner peace...</p>
                <div class="breathing-orb" id="breathingOrb"></div>
                <div class="meditation-timer" id="meditationTimer">1:00</div>
                <button class="magical-btn" onclick="startMeditation()" id="meditationBtn">üßò Begin Meditation</button>
            </div>
        </div>
    </div>

    <!-- Undo Toast -->
    <div class="undo-toast" id="undoToast">
        <span id="undoText">Food item deleted</span>
        <button onclick="undoLastAction()" style="background: none; border: none; color: var(--secondary); margin-left: 1rem; cursor: pointer;">UNDO</button>
    </div>

    <!-- Food Tracker Page -->
    <div class="tracker-page" id="trackerPage">
        <div class="tracker-header">
            <button class="goals-btn" onclick="openGoalsModal()">üéØ Goals</button>
            <button class="customize-btn" onclick="openCustomizeModal()">‚öôÔ∏è Customize</button>
            <button class="chest-btn" onclick="openChestModal()">üèÜ Chest</button>
            <button class="week-btn" onclick="openWeekModal()">üìä Week</button>
            
            <h1 class="tracker-title">Wyrnwick Academy</h1>
            <p class="house-welcome" id="houseWelcome">Welcome, Student!</p>
            
            <div class="character-info" id="characterInfo">
                <div>ü™Ñ <span id="wandType">Phoenix Core</span></div>
                <div>üêæ <span id="companionType">Wise Owl</span></div>
                <div>üë§ <span id="backgroundType">Royal Bloodline</span></div>
            </div>
            
            <div class="streak-info" id="streakInfo">
                <div>üî• <span id="streakCount">0</span> Day Streak</div>
                <div>üèÜ Champion: <span id="championHouse">Loading...</span></div>
            </div>
            
            <div class="xp-container">
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <div class="xp-text" id="xpText">Level 1 - 0 / 100 XP</div>
            </div>
        </div>

        <div class="tracker-content">
            <!-- Food Input Section -->
            <div class="magical-card">
                <h2 class="card-title">ü™Ñ Nutrition Tracker</h2>
                
                <div class="input-group">
                    <div class="input-container">
                        <input type="text" id="foodInput" class="magical-input" placeholder="Search for food..." autocomplete="off">
                        <div class="suggest-dropdown" id="suggestDropdown"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-row">
                        <input type="number" id="quantityInput" class="magical-input" placeholder="Quantity" value="1" step="0.1" min="0.1">
                        <select id="unitSelect" class="magical-select">
                            <option value="g">grams</option>
                            <option value="oz">oz</option>
                            <option value="cup">cup</option>
                            <option value="tbsp">tbsp</option>
                            <option value="slice">slice</option>
                            <option value="piece">piece</option>
                        </select>
                    </div>
                </div>

                <div class="nutrition-preview" id="nutritionPreview" style="display: none;">
                    <div id="previewText">Select a food to see nutrition info</div>
                </div>
                
                <button class="magical-btn" onclick="addMeal()" id="addMealBtn">‚ú® Add to Log</button>
                
                <!-- Goals Display -->
                <div class="goals-container">
                    <div class="calorie-ring">
                        <div class="ring-bg"></div>
                        <div class="ring-fill" id="calorieRing"></div>
                        <div class="ring-text">
                            <div class="ring-calories" id="ringCalories">0</div>
                            <div class="ring-remaining" id="ringRemaining">remaining</div>
                        </div>
                    </div>
                    
                    <div class="macro-bars">
                        <div class="macro-bar">
                            <div class="macro-name" style="color: #ef4444;">Protein</div>
                            <div class="macro-progress">
                                <div class="macro-fill protein-fill" id="proteinFill"></div>
                            </div>
                            <div class="macro-text" id="proteinText">0g / 0g</div>
                        </div>
                        <div class="macro-bar">
                            <div class="macro-name" style="color: #3b82f6;">Carbs</div>
                            <div class="macro-progress">
                                <div class="macro-fill carbs-fill" id="carbsFill"></div>
                            </div>
                            <div class="macro-text" id="carbsText">0g / 0g</div>
                        </div>
                        <div class="macro-bar">
                            <div class="macro-name" style="color: #f59e0b;">Fat</div>
                            <div class="macro-progress">
                                <div class="macro-fill fat-fill" id="fatFill"></div>
                            </div>
                            <div class="macro-text" id="fatText">0g / 0g</div>
                        </div>
                    </div>
                </div>
                
                <div class="food-log" id="foodLog"></div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="magical-btn" onclick="openPotionModal()" style="flex: 1;">üß™ Brew Potion</button>
                    <button class="magical-btn" onclick="openStudyModal()" style="flex: 1;">üìö Study Hall</button>
                </div>
                
                <button class="magical-btn" onclick="clearDay()" style="background: linear-gradient(45deg, #8b0000, #dc2626); margin-top: 1rem;">üßπ Clear Today's Log</button>
            </div>

            <!-- Stats and Features Section -->
            <div style="display: grid; gap: 2rem;">
                <!-- Weekly Challenges -->
                <div class="magical-card">
                    <h2 class="card-title">üìÖ Weekly Challenges</h2>
                    <div class="challenge-list" id="challengeList"></div>
                </div>

                <!-- House Tournament -->
                <div class="magical-card">
                    <h2 class="card-title">üèÜ House Tournament</h2>
                    <div class="leaderboard" id="houseLeaderboard"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Food Database with Macros
        const FOODS_CATALOG = [
            // Fruits
            { id: 'apple', name: 'Apple, raw', per: '100g', kcal: 52, protein: 0.3, carbs: 14, fat: 0.2, aliases: ['apple', 'red apple', 'green apple'] },
            { id: 'banana', name: 'Banana, raw', per: '100g', kcal: 89, protein: 1.1, carbs: 23, fat: 0.3, aliases: ['banana'] },
            { id: 'orange', name: 'Orange, raw', per: '100g', kcal: 47, protein: 0.9, carbs: 12, fat: 0.1, aliases: ['orange'] },
            { id: 'grapes', name: 'Grapes, raw', per: '100g', kcal: 62, protein: 0.6, carbs: 16, fat: 0.2, aliases: ['grapes', 'grape'] },
            { id: 'strawberries', name: 'Strawberries, raw', per: '100g', kcal: 32, protein: 0.7, carbs: 8, fat: 0.3, aliases: ['strawberry', 'strawberries'] },
            { id: 'avocado', name: 'Avocado, raw', per: '100g', kcal: 160, protein: 2, carbs: 9, fat: 15, aliases: ['avocado'] },
            
            // Proteins
            { id: 'chicken_breast', name: 'Chicken Breast, skinless', per: '100g', kcal: 165, protein: 31, carbs: 0, fat: 3.6, aliases: ['chicken', 'chicken breast', 'grilled chicken'] },
            { id: 'salmon', name: 'Salmon, cooked', per: '100g', kcal: 206, protein: 22, carbs: 0, fat: 12, aliases: ['salmon', 'fish'] },
            { id: 'eggs', name: 'Eggs, whole, cooked', per: '100g', kcal: 155, protein: 13, carbs: 1.1, fat: 11, aliases: ['egg', 'eggs', 'scrambled eggs'] },
            { id: 'beef', name: 'Beef, lean, cooked', per: '100g', kcal: 250, protein: 26, carbs: 0, fat: 15, aliases: ['beef', 'steak'] },
            { id: 'tuna', name: 'Tuna, canned in water', per: '100g', kcal: 116, protein: 26, carbs: 0, fat: 1, aliases: ['tuna'] },
            
            // Dairy
            { id: 'milk', name: 'Milk, whole', per: '100g', kcal: 61, protein: 3.2, carbs: 4.8, fat: 3.3, aliases: ['milk'] },
            { id: 'cheese_cheddar', name: 'Cheese, cheddar', per: '100g', kcal: 403, protein: 25, carbs: 1.3, fat: 33, aliases: ['cheese', 'cheddar'] },
            { id: 'yogurt', name: 'Yogurt, plain', per: '100g', kcal: 59, protein: 10, carbs: 3.6, fat: 0.4, aliases: ['yogurt', 'greek yogurt'] },
            
            // Grains & Carbs
            { id: 'rice_white', name: 'Rice, white, cooked', per: '100g', kcal: 130, protein: 2.7, carbs: 28, fat: 0.3, aliases: ['rice', 'white rice'] },
            { id: 'pasta', name: 'Pasta, cooked', per: '100g', kcal: 131, protein: 5, carbs: 25, fat: 1.1, aliases: ['pasta', 'spaghetti'] },
            { id: 'bread_whole', name: 'Bread, whole wheat', per: '100g', kcal: 247, protein: 13, carbs: 41, fat: 4.2, aliases: ['bread', 'whole wheat bread'] },
            { id: 'oats', name: 'Oats, cooked', per: '100g', kcal: 68, protein: 2.4, carbs: 12, fat: 1.4, aliases: ['oats', 'oatmeal'] },
            { id: 'potato', name: 'Potato, baked', per: '100g', kcal: 161, protein: 4.3, carbs: 37, fat: 0.1, aliases: ['potato', 'baked potato'] },
            
            // Vegetables
            { id: 'broccoli', name: 'Broccoli, cooked', per: '100g', kcal: 35, protein: 2.4, carbs: 7, fat: 0.4, aliases: ['broccoli'] },
            { id: 'spinach', name: 'Spinach, raw', per: '100g', kcal: 23, protein: 2.9, carbs: 3.6, fat: 0.4, aliases: ['spinach'] },
            { id: 'carrots', name: 'Carrots, raw', per: '100g', kcal: 41, protein: 0.9, carbs: 10, fat: 0.2, aliases: ['carrot', 'carrots'] },
            
            // Nuts & Seeds
            { id: 'almonds', name: 'Almonds, raw', per: '100g', kcal: 579, protein: 21, carbs: 22, fat: 50, aliases: ['almond', 'almonds'] },
            { id: 'peanut_butter', name: 'Peanut Butter, smooth', per: '15g', kcal: 94, protein: 4, carbs: 3.1, fat: 8, aliases: ['peanut butter', 'pb'] },
            { id: 'walnuts', name: 'Walnuts, raw', per: '100g', kcal: 654, protein: 15, carbs: 14, fat: 65, aliases: ['walnut', 'walnuts'] },
            
            // Treats
            { id: 'chocolate', name: 'Chocolate, dark 70%', per: '100g', kcal: 546, protein: 7.8, carbs: 45, fat: 31, aliases: ['chocolate', 'dark chocolate'] },
            { id: 'ice_cream', name: 'Ice Cream, vanilla', per: '100g', kcal: 207, protein: 3.5, carbs: 24, fat: 11, aliases: ['ice cream'] },
            
            // Fast Food
            { id: 'pizza', name: 'Pizza, cheese', per: '100g', kcal: 285, protein: 12, carbs: 35, fat: 10, aliases: ['pizza'] },
            { id: 'burger', name: 'Hamburger, fast food', per: '100g', kcal: 295, protein: 17, carbs: 28, fat: 14, aliases: ['burger', 'hamburger'] },
            { id: 'fries', name: 'French Fries', per: '100g', kcal: 365, protein: 4, carbs: 63, fat: 17, aliases: ['fries', 'french fries'] }
        ];

        // Unit Conversion Map (to grams)
        const UNIT_MAP = {
            'g': 1,
            'oz': 28.3495,
            'cup': { 'rice_white': 185, 'pasta': 140, 'milk': 240, 'flour': 120, 'default': 240 },
            'tbsp': { 'peanut_butter': 16, 'oil': 14, 'default': 15 },
            'slice': { 'bread_whole': 28, 'cheese_cheddar': 28, 'default': 25 },
            'piece': { 'apple': 180, 'banana': 120, 'orange': 150, 'default': 100 }
        };

        // Valid student keys
        const validKeys = ['WIZARD123', 'MAGIC456', 'ACADEMY789', 'STUDENT101'];
        
        // Character customization data
        let characterData = {
            wand: 'phoenix',
            companion: 'owl',
            background: 'royal'
        };

        // Global app state
        let selectedFood = null;
        let lastDeletedMeal = null;
        let recentFoods = [];
        let favoriteFoods = [];

        // Potion brewing data
        let potionData = {
            ingredient: null,
            boost: null,
            dailyPotion: false
        };

        // Meditation data
        let meditationActive = false;
        let meditationTimer = null;

        // Weekly challenges
        const weeklyPrompts = [
            { id: 'log_meals', text: 'Log 7 meals this week', reward: '50 XP + Weekly Rune', target: 7 },
            { id: 'house_points', text: 'Earn 300 House Points', reward: '30 XP', target: 300 },
            { id: 'brew_potions', text: 'Brew 5 potions', reward: '40 XP', target: 5 },
            { id: 'meditation', text: 'Complete 3 meditation sessions', reward: '25 XP', target: 3 },
            { id: 'streak_days', text: 'Maintain 5-day streak', reward: '60 XP + Streak Rune', target: 5 },
            { id: 'hit_protein', text: 'Hit protein goal 5 days', reward: '35 XP', target: 5 },
            { id: 'stay_under_cal', text: 'Stay under calorie goal 4 days', reward: '25 XP', target: 4 }
        ];

        // Trophy definitions
        const TROPHIES = [
            { id: 'first_meal', name: 'First Feast', icon: 'üçé', desc: 'Log your first meal', condition: (data) => (data.mealsLogged || 0) >= 1 },
            { id: 'macro_master', name: 'Macro Master', icon: 'üí™', desc: 'Hit all macro goals in one day', condition: (data) => data.hitAllMacros },
            { id: 'calorie_king', name: 'Calorie King', icon: 'üëë', desc: 'Stay within calorie goal for 7 days', condition: (data) => (data.calorieGoalDays || 0) >= 7 },
            { id: 'protein_power', name: 'Protein Power', icon: 'ü•©', desc: 'Hit protein goal 10 times', condition: (data) => (data.proteinGoalHits || 0) >= 10 },
            { id: 'streak_star', name: 'Streak Star', icon: '‚≠ê', desc: 'Maintain 14-day streak', condition: (data) => (data.streak || 0) >= 14 },
            { id: 'level_legend', name: 'Level Legend', icon: 'üèÜ', desc: 'Reach level 10', condition: (data) => (data.level || 1) >= 10 },
            { id: 'house_hero', name: 'House Hero', icon: 'üõ°Ô∏è', desc: 'Earn 2000 house points', condition: (data) => (data.housePoints || 0) >= 2000 },
            { id: 'nutrition_ninja', name: 'Nutrition Ninja', icon: 'ü•∑', desc: 'Log 100 meals', condition: (data) => (data.mealsLogged || 0) >= 100 },
            { id: 'potion_master', name: 'Potion Master', icon: 'üß™', desc: 'Brew 20 potions', condition: (data) => (data.potionsBrewed || 0) >= 20 },
            { id: 'zen_master', name: 'Zen Master', icon: 'üßò', desc: 'Complete 25 meditation sessions', condition: (data) => (data.meditationSessions || 0) >= 25 },
            { id: 'challenge_champ', name: 'Challenge Champion', icon: 'üéØ', desc: 'Complete 10 weekly challenges', condition: (data) => (data.challengesCompleted || 0) >= 10 },
            { id: 'ultimate_wizard', name: 'Ultimate Wizard', icon: 'üîÆ', desc: 'Unlock all other trophies', condition: (data) => {
                const otherTrophies = TROPHIES.filter(t => t.id !== 'ultimate_wizard');
                const earned = data.earnedTrophies || [];
                return otherTrophies.every(t => earned.includes(t.id));
            }}
        ];

        // Data Management Functions
        function loadData() {
            const data = JSON.parse(localStorage.getItem('wyrnwickData') || '{}');
            
            // Load character data
            if (data.character) {
                characterData = data.character;
            }
            
            // Load recent and favorite foods
            recentFoods = data.recentFoods || [];
            favoriteFoods = data.favoriteFoods || [];
            
            // Check if it's a new day
            const today = new Date().toDateString();
            const lastLogin = data.lastLogin || '';

            if (lastLogin !== today) {
                // New day - reset daily stats but keep everything else
                if (!data.days) data.days = {};
                if (data.mealsToday && data.mealsToday.length > 0) {
                    // Save yesterday's data
                    data.days[lastLogin] = {
                        meals: data.mealsToday || [],
                        totals: data.dailyTotals || { kcal: 0, protein: 0, carbs: 0, fat: 0 }
                    };
                }
                
                data.mealsToday = [];
                data.dailyTotals = { kcal: 0, protein: 0, carbs: 0, fat: 0 };
                data.lastLogin = today;
                localStorage.setItem('wyrnwickData', JSON.stringify(data));
            }

            return data;
        }

        function saveData(data) {
            localStorage.setItem('wyrnwickData', JSON.stringify(data));
        }

        // Unit Conversion Functions
        function convertToGrams(quantity, unit, foodId) {
            if (unit === 'g') return quantity;
            
            if (typeof UNIT_MAP[unit] === 'object') {
                return quantity * (UNIT_MAP[unit][foodId] || UNIT_MAP[unit].default);
            }
            
            return quantity * (UNIT_MAP[unit] || 1);
        }

        function calculateNutrition(food, quantity, unit) {
            const grams = convertToGrams(quantity, unit, food.id);
            const factor = grams / 100; // Most foods are per 100g
            
            if (food.per !== '100g') {
                // Handle foods with different base serving
                const baseGrams = parseFloat(food.per.replace('g', ''));
                const baseFactor = grams / baseGrams;
                return {
                    kcal: Math.round(food.kcal * baseFactor),
                    protein: Math.round(food.protein * baseFactor * 10) / 10,
                    carbs: Math.round(food.carbs * baseFactor * 10) / 10,
                    fat: Math.round(food.fat * baseFactor * 10) / 10,
                    grams: grams
                };
            }
            
            return {
                kcal: Math.round(food.kcal * factor),
                protein: Math.round(food.protein * factor * 10) / 10,
                carbs: Math.round(food.carbs * factor * 10) / 10,
                fat: Math.round(food.fat * factor * 10) / 10,
                grams: grams
            };
        }

        // Goals Calculation Functions
        function calculateBMR(profile) {
            const { sex, age, height_cm, weight_kg } = profile;
            
            if (sex === 'male') {
                return 10 * weight_kg + 6.25 * height_cm - 5 * age + 5;
            } else {
                return 10 * weight_kg + 6.25 * height_cm - 5 * age - 161;
            }
        }

        function calculateTDEE(profile) {
            const bmr = calculateBMR(profile);
            const activityFactors = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            
            return Math.round(bmr * activityFactors[profile.activity]);
        }

        function calculateGoalCalories(profile) {
            const tdee = calculateTDEE(profile);
            
            switch (profile.goal) {
                case 'fat_loss': return tdee - 500;
                case 'muscle_gain': return tdee + 300;
                default: return tdee;
            }
        }

        function calculateMacroTargets(profile, calories) {
            const { weight_kg } = profile;
            
            // Default macro targets
            const proteinTarget = Math.round(weight_kg * 1.8); // 1.8g per kg
            const fatTarget = Math.round(weight_kg * 0.8); // 0.8g per kg
            const proteinCals = proteinTarget * 4;
            const fatCals = fatTarget * 9;
            const carbCals = calories - proteinCals - fatCals;
            const carbTarget = Math.round(carbCals / 4);
            
            return {
                protein: proteinTarget,
                carbs: Math.max(0, carbTarget),
                fat: fatTarget
            };
        }

        // Search Functions
        function fuzzySearch(query, foods) {
            if (!query || query.length < 2) return [];
            
            const lowerQuery = query.toLowerCase();
            const results = [];
            
            foods.forEach(food => {
                let score = 0;
                
                // Exact name match gets highest score
                if (food.name.toLowerCase().includes(lowerQuery)) {
                    score += 100;
                }
                
                // Alias matches
                if (food.aliases) {
                    food.aliases.forEach(alias => {
                        if (alias.toLowerCase().includes(lowerQuery)) {
                            score += 80;
                        }
                    });
                }
                
                // Fuzzy matching for typos
                if (score === 0) {
                    const distance = levenshteinDistance(lowerQuery, food.name.toLowerCase());
                    if (distance <= 2) {
                        score += 50 - (distance * 10);
                    }
                }
                
                if (score > 0) {
                    results.push({ food, score });
                }
            });
            
            return results
                .sort((a, b) => b.score - a.score)
                .slice(0, 8)
                .map(r => r.food);
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Character customization functions
        function openCustomizeModal() {
            document.getElementById('customizeModal').style.display = 'flex';
            loadCustomizationData();
            
            // Add keyboard support
            document.addEventListener('keydown', handleCustomizeKeydown);
        }

        function closeCustomizeModal() {
            document.getElementById('customizeModal').style.display = 'none';
            
            // Remove keyboard support
            document.removeEventListener('keydown', handleCustomizeKeydown);
        }

        function handleCustomizeKeydown(e) {
            if (e.key === 'Enter') {
                saveCustomization();
            } else if (e.key === 'Escape') {
                closeCustomizeModal();
            }
        }

        function selectOption(category, option) {
            // Remove selected class from all options in this category
            document.querySelectorAll(`[id^="${category}-"]`).forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selected class to chosen option
            document.getElementById(`${category}-${option}`).classList.add('selected');
            characterData[category] = option;
        }

        function loadCustomizationData() {
            const data = loadData();
            if (data.character) {
                characterData = data.character;
                
                // Update UI to show selected options
                Object.keys(characterData).forEach(category => {
                    const option = characterData[category];
                    document.querySelectorAll(`[id^="${category}-"]`).forEach(el => {
                        el.classList.remove('selected');
                    });
                    if (document.getElementById(`${category}-${option}`)) {
                        document.getElementById(`${category}-${option}`).classList.add('selected');
                    }
                });
            }
        }

        function saveCustomization() {
            let data = loadData();
            data.character = characterData;
            saveData(data);
            
            updateCharacterDisplay();
            closeCustomizeModal();
        }

        function updateCharacterDisplay() {
            const wandTypes = {
                phoenix: 'Phoenix Core',
                dragon: 'Dragon Heartstring',
                unicorn: 'Unicorn Hair'
            };
            
            const companionTypes = {
                owl: 'Wise Owl',
                cat: 'Shadow Cat',
                toad: 'Ancient Toad'
            };
            
            const backgroundTypes = {
                royal: 'Royal Bloodline',
                forest: 'Forest Folk',
                shadow: 'Shadow Walker'
            };

            document.getElementById('wandType').textContent = wandTypes[characterData.wand];
            document.getElementById('companionType').textContent = companionTypes[characterData.companion];
            document.getElementById('backgroundType').textContent = backgroundTypes[characterData.background];
        }

        // Goals Modal Functions
        function openGoalsModal() {
            document.getElementById('goalsModal').style.display = 'flex';
            loadGoalsData();
        }

        function closeGoalsModal() {
            document.getElementById('goalsModal').style.display = 'none';
        }

        function loadGoalsData() {
            const data = loadData();
            const profile = data.profile || {
                sex: 'male',
                age: 25,
                height_cm: 175,
                weight_kg: 70,
                activity: 'moderate',
                goal: 'maintenance'
            };

            document.getElementById('profileSex').value = profile.sex;
            document.getElementById('profileAge').value = profile.age;
            document.getElementById('profileHeight').value = profile.height_cm;
            document.getElementById('profileWeight').value = profile.weight_kg;
            document.getElementById('profileActivity').value = profile.activity;
            document.getElementById('profileGoal').value = profile.goal;
        }

        function calculateGoals() {
            const profile = {
                sex: document.getElementById('profileSex').value,
                age: parseInt(document.getElementById('profileAge').value),
                height_cm: parseInt(document.getElementById('profileHeight').value),
                weight_kg: parseInt(document.getElementById('profileWeight').value),
                activity: document.getElementById('profileActivity').value,
                goal: document.getElementById('profileGoal').value
            };

            const bmr = calculateBMR(profile);
            const tdee = calculateTDEE(profile);
            const goalCalories = calculateGoalCalories(profile);
            const macros = calculateMacroTargets(profile, goalCalories);

            document.getElementById('calculatedGoals').style.display = 'block';
            document.getElementById('goalsDisplay').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div><strong>BMR:</strong> ${Math.round(bmr)} cal</div>
                    <div><strong>TDEE:</strong> ${tdee} cal</div>
                    <div><strong>Goal:</strong> ${goalCalories} cal</div>
                    <div><strong>Protein:</strong> ${macros.protein}g</div>
                    <div><strong>Carbs:</strong> ${macros.carbs}g</div>
                    <div><strong>Fat:</strong> ${macros.fat}g</div>
                </div>
            `;
        }

        function saveGoals() {
            const profile = {
                sex: document.getElementById('profileSex').value,
                age: parseInt(document.getElementById('profileAge').value),
                height_cm: parseInt(document.getElementById('profileHeight').value),
                weight_kg: parseInt(document.getElementById('profileWeight').value),
                activity: document.getElementById('profileActivity').value,
                goal: document.getElementById('profileGoal').value
            };

            const goalCalories = calculateGoalCalories(profile);
            const macros = calculateMacroTargets(profile, goalCalories);

            let data = loadData();
            data.profile = profile;
            data.goals = {
                calories: goalCalories,
                protein: macros.protein,
                carbs: macros.carbs,
                fat: macros.fat
            };
            saveData(data);

            closeGoalsModal();
            updateGoalsDisplay();
            alert('‚ú® Goals saved successfully!');
        }

        // Food Input Functions
        function setupFoodSearch() {
            const input = document.getElementById('foodInput');
            const dropdown = document.getElementById('suggestDropdown');
            const quantityInput = document.getElementById('quantityInput');
            const unitSelect = document.getElementById('unitSelect');

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 2) {
                    dropdown.style.display = 'none';
                    selectedFood = null;
                    updateNutritionPreview();
                    return;
                }

                // Combine recent, favorites, and search results
                let suggestions = [];
                
                // Add recent foods first (if they match)
                const recentMatches = recentFoods
                    .map(id => FOODS_CATALOG.find(f => f.id === id))
                    .filter(food => food && (
                        food.name.toLowerCase().includes(value) ||
                        food.aliases.some(alias => alias.toLowerCase().includes(value))
                    ));
                
                suggestions = suggestions.concat(recentMatches);
                
                // Add search results
                const searchResults = fuzzySearch(value, FOODS_CATALOG);
                searchResults.forEach(food => {
                    if (!suggestions.find(s => s.id === food.id)) {
                        suggestions.push(food);
                    }
                });

                if (suggestions.length > 0) {
                    dropdown.innerHTML = suggestions.slice(0, 6).map(food => `
                        <div class="suggest-item" onclick="selectFood('${food.id}')">
                            <div class="suggest-food-name">${food.name} ${favoriteFoods.includes(food.id) ? '‚≠ê' : ''}</div>
                            <div class="suggest-food-info">${food.kcal} cal ¬∑ ${food.protein}p ¬∑ ${food.carbs}c ¬∑ ${food.fat}f per ${food.per}</div>
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });

            // Update preview when quantity or unit changes
            quantityInput.addEventListener('input', updateNutritionPreview);
            unitSelect.addEventListener('change', updateNutritionPreview);

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.input-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectFood(foodId) {
            const food = FOODS_CATALOG.find(f => f.id === foodId);
            if (food) {
                selectedFood = food;
                document.getElementById('foodInput').value = food.name;
                document.getElementById('suggestDropdown').style.display = 'none';
                updateNutritionPreview();
                
                // Update unit options based on food
                updateUnitOptions(food);
            }
        }

        function updateUnitOptions(food) {
            const unitSelect = document.getElementById('unitSelect');
            const standardUnits = ['g', 'oz'];
            
            // Add food-specific units
            const foodSpecificUnits = [];
            Object.keys(UNIT_MAP).forEach(unit => {
                if (typeof UNIT_MAP[unit] === 'object' && UNIT_MAP[unit][food.id]) {
                    foodSpecificUnits.push(unit);
                }
            });
            
            const allUnits = [...standardUnits, ...foodSpecificUnits];
            
            unitSelect.innerHTML = allUnits.map(unit => 
                `<option value="${unit}">${unit}</option>`
            ).join('');
        }

        function updateNutritionPreview() {
            const preview = document.getElementById('nutritionPreview');
            const previewText = document.getElementById('previewText');
            
            if (!selectedFood) {
                preview.style.display = 'none';
                return;
            }
            
            const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;
            const unit = document.getElementById('unitSelect').value;
            
            const nutrition = calculateNutrition(selectedFood, quantity, unit);
            
            previewText.innerHTML = `
                <strong>= ${nutrition.kcal} cal</strong> ¬∑ 
                ${nutrition.protein}g protein ¬∑ 
                ${nutrition.carbs}g carbs ¬∑ 
                ${nutrition.fat}g fat
                <br><small>(${nutrition.grams}g total)</small>
            `;
            
            preview.style.display = 'block';
        }

        function addMeal() {
            if (!selectedFood) {
                alert('Please select a food first!');
                return;
            }
            
            const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;
            const unit = document.getElementById('unitSelect').value;
            
            const nutrition = calculateNutrition(selectedFood, quantity, unit);
            
            const meal = {
                id: Date.now().toString(),
                foodId: selectedFood.id,
                foodName: selectedFood.name,
                quantity: quantity,
                unit: unit,
                nutrition: nutrition,
                timestamp: Date.now()
            };
            
            let data = loadData();
            if (!data.mealsToday) data.mealsToday = [];
            if (!data.dailyTotals) data.dailyTotals = { kcal: 0, protein: 0, carbs: 0, fat: 0 };
            
            // Add meal
            data.mealsToday.push(meal);
            
            // Update totals
            data.dailyTotals.kcal += nutrition.kcal;
            data.dailyTotals.protein += nutrition.protein;
            data.dailyTotals.carbs += nutrition.carbs;
            data.dailyTotals.fat += nutrition.fat;
            
            // Update tracking stats
            data.mealsLogged = (data.mealsLogged || 0) + 1;
            data.housePoints = (data.housePoints || 0) + Math.floor(nutrition.kcal / 10);
            
            // Add to recent foods
            if (!recentFoods.includes(selectedFood.id)) {
                recentFoods.unshift(selectedFood.id);
                recentFoods = recentFoods.slice(0, 15); // Keep last 15
                data.recentFoods = recentFoods;
            }
            
            saveData(data);
            
            // Update streak
            updateStreak();
            
            // Add XP
            addXP(10);
            
            // Update challenges
            updateChallengeProgress('log_meals', 1);
            updateChallengeProgress('house_points', Math.floor(nutrition.kcal / 10));
            
            // Show gain animation
            showNutritionGain(nutrition.kcal);
            
            // Clear inputs
            document.getElementById('foodInput').value = '';
            document.getElementById('quantityInput').value = '1';
            selectedFood = null;
            updateNutritionPreview();
            
            // Update displays
            updateFoodLog();
            updateGoalsDisplay();
            checkTrophies();
            updateHouseTournament();
        }

        function editMeal(mealId) {
            let data = loadData();
            const meal = data.mealsToday.find(m => m.id === mealId);
            
            if (meal) {
                // Populate form with meal data
                const food = FOODS_CATALOG.find(f => f.id === meal.foodId);
                if (food) {
                    selectFood(food.id);
                    document.getElementById('quantityInput').value = meal.quantity;
                    document.getElementById('unitSelect').value = meal.unit;
                    updateNutritionPreview();
                    
                    // Remove the meal (will be re-added when user submits)
                    deleteMeal(mealId, false);
                }
            }
        }

        function deleteMeal(mealId, showUndo = true) {
            let data = loadData();
            const mealIndex = data.mealsToday.findIndex(m => m.id === mealId);
            
            if (mealIndex !== -1) {
                const meal = data.mealsToday[mealIndex];
                
                // Store for undo
                if (showUndo) {
                    lastDeletedMeal = { meal, index: mealIndex };
