<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogsworth Academy - Legendary Nutrition Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Magical Background Effects */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .floating-sparkles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            animation: float 6s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Harry Potter House Themes */
        .serpent { 
            --primary: #1a4d2e; 
            --secondary: #c0c0c0; 
            --accent: #2d5a3d;
            --house-main: #1a4d2e;
            --house-accent: #c0c0c0;
        }
        .griffin { 
            --primary: #740001; 
            --secondary: #ffd700; 
            --accent: #ae0001;
            --house-main: #740001;
            --house-accent: #ffd700;
        }
        .raven { 
            --primary: #0e1a40; 
            --secondary: #946b2d; 
            --accent: #222f5b;
            --house-main: #0e1a40;
            --house-accent: #946b2d;
        }
        .hufflecrest { 
            --primary: #ecb939; 
            --secondary: #372e29; 
            --accent: #f0c75e;
            --house-main: #ecb939;
            --house-accent: #372e29;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #4ade80, #22c55e);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: toastSlide 0.5s ease;
            font-weight: bold;
        }

        .toast.error {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        @keyframes toastSlide {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Student Key Gate */
        .key-gate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .admission-letter {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.5);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-width: 500px;
            animation: letterGlow 3s infinite;
        }

        @keyframes letterGlow {
            0%, 100% { box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
            50% { box-shadow: 0 20px 40px rgba(255,215,0,0.2); }
        }

        .admission-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .admission-text {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .key-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }

        .enter-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .enter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255,215,0,0.3);
        }

        .skip-link {
            color: rgba(255,215,0,0.7);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: color 0.3s ease;
        }

        .skip-link:hover {
            color: #ffd700;
        }

        /* Welcome Page Styles */
        .welcome-page {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .academy-logo {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: logoShimmer 3s infinite;
        }

        @keyframes logoShimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .academy-subtitle {
            font-size: 1.4rem;
            font-style: italic;
            color: #ffd700;
            margin-bottom: 3rem;
            text-align: center;
        }

        .house-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
        }

        .house-crest {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .house-crest.serpent {
            border-color: #1a4d2e;
            background: linear-gradient(145deg, rgba(26,77,46,0.2), rgba(26,77,46,0.1));
        }

        .house-crest.griffin {
            border-color: #740001;
            background: linear-gradient(145deg, rgba(116,0,1,0.2), rgba(116,0,1,0.1));
        }

        .house-crest.raven {
            border-color: #0e1a40;
            background: linear-gradient(145deg, rgba(14,26,64,0.2), rgba(14,26,64,0.1));
        }

        .house-crest.hufflecrest {
            border-color: #ecb939;
            background: linear-gradient(145deg, rgba(236,185,57,0.2), rgba(236,185,57,0.1));
        }

        .house-crest::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
            transform: rotate(-45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .house-crest:hover::before {
            opacity: 1;
            transform: rotate(-45deg) translate(50%, 50%);
        }

        .house-crest:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .house-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
        }

        .house-character {
            font-size: 5rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            transition: transform 0.3s ease;
        }

        .house-crest:hover .house-character {
            transform: scale(1.1) rotate(5deg);
        }

        .house-name {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .house-crest.serpent .house-name { color: #c0c0c0; }
        .house-crest.griffin .house-name { color: #ffd700; }
        .house-crest.raven .house-name { color: #946b2d; }
        .house-crest.hufflecrest .house-name { color: #372e29; }

        .house-motto {
            font-style: italic;
            color: #ccc;
            font-size: 1rem;
        }

        /* Tracker Page Styles */
        .tracker-page {
            display: none;
            padding: 2rem;
            position: relative;
            z-index: 10;
        }

        .tracker-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 20px;
            border: 3px solid var(--secondary);
            position: relative;
            overflow: hidden;
        }

        .tracker-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: headerSweep 8s infinite;
        }

        @keyframes headerSweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tracker-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .house-welcome {
            font-size: 1.2rem;
            color: #fff;
            font-style: italic;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .character-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.9rem;
            color: #ddd;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .streak-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 1rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }

        .nav-btn {
            position: absolute;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 3;
        }

        .nav-btn:hover {
            background: var(--secondary);
            color: var(--primary);
            transform: scale(1.05);
        }

        .goals-btn { top: 1rem; left: 1rem; }
        .chest-btn { top: 1rem; right: 1rem; }
        .week-btn { top: 3.5rem; left: 1rem; }
        .customize-btn { top: 3.5rem; right: 1rem; }

        /* XP Bar */
        .xp-container {
            margin: 1rem 0;
            position: relative;
            z-index: 2;
        }

        .xp-bar {
            height: 30px;
            background: linear-gradient(90deg, #000, #333);
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid var(--secondary);
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9333ea, #c084fc, #e879f9);
            transition: width 1.2s ease;
            border-radius: 15px;
            position: relative;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-text {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: bold;
            color: var(--secondary);
            font-size: 1rem;
        }

        .tracker-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .magical-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.4);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }

        .magical-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.1), transparent);
            animation: cardGlow 3s infinite;
        }

        @keyframes cardGlow {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: var(--secondary);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .input-group {
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
        }

        .magical-input, .magical-select {
            padding: 15px 18px;
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 12px;
            background: rgba(0,0,0,0.4);
            color: #fff;
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
        }

        .magical-input {
            width: 100%;
        }

        .magical-select {
            min-width: 90px;
        }

        .magical-input:focus, .magical-select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
            transform: scale(1.02);
        }

        .magical-btn {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            font-family: 'Crimson Text', serif;
            position: relative;
            z-index: 2;
        }

        .magical-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .magical-btn.secondary {
            background: linear-gradient(45deg, #4b5563, #6b7280);
        }

        /* Enhanced Nutrition Preview */
        .nutrition-preview {
            background: linear-gradient(45deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 12px;
            padding: 15px;
            margin: 1rem 0;
            text-align: center;
            font-size: 1rem;
            position: relative;
            z-index: 2;
        }

        .preview-title {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .preview-macros {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .preview-macro {
            text-align: center;
        }

        .preview-value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .preview-label {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Food Search Suggestions */
        .suggest-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(0,0,0,0.8));
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }

        .suggest-item:hover {
            background: rgba(255,215,0,0.2);
        }

        .suggest-item:last-child {
            border-bottom: none;
        }

        .suggest-food-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.2rem;
        }

        .suggest-food-info {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Enhanced Goals & Macros */
        .goals-container {
            margin: 2rem 0;
            position: relative;
            z-index: 2;
        }

        .calorie-ring {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 1rem;
        }

        .ring-bg {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background:
                radial-gradient(circle 56px, #0a0a0a 56px, transparent 57px),
                radial-gradient(circle 68px, rgba(255,255,255,.15) 68px, transparent 69px),
                conic-gradient(rgba(255,255,255,.18) 0 360deg);
        }

        .ring-fill {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            transition: background 1s ease;
        }

        .ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .ring-calories {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .ring-remaining {
            font-size: 0.9rem;
            color: #ccc;
        }

        .macro-bars {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .macro-bar {
            text-align: center;
        }

        .macro-name {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .macro-progress {
            height: 10px;
            background: rgba(0,0,0,0.4);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .macro-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 5px;
        }

        .protein-fill { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .carbs-fill { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .fat-fill { background: linear-gradient(90deg, #f59e0b, #d97706); }

        .macro-text {
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Enhanced Food Log */
        .food-log {
            max-height: 450px;
            overflow-y: auto;
            margin-top: 1rem;
            position: relative;
            z-index: 2;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05));
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            animation: foodAppear 0.6s ease;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .food-item:hover {
            background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
            transform: translateY(-2px);
        }

        @keyframes foodAppear {
            from { opacity: 0; transform: translateY(-30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .food-details {
            flex: 1;
        }

        .food-name {
            font-weight: bold;
            margin-bottom: 0.3rem;
            font-size: 1.1rem;
        }

        .food-macros {
            font-size: 0.9rem;
            color: #ccc;
        }

        .food-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: rgba(255,215,0,0.2);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .action-btn:hover {
            background: var(--secondary);
            color: var(--primary);
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: modalFade 0.3s ease;
        }

        @keyframes modalFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 3px solid rgba(255,215,0,0.5);
            border-radius: 20px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            backdrop-filter: blur(15px);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translate(-50%, -60%) scale(0.9); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--secondary);
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tracker-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .house-selection {
                grid-template-columns: 1fr;
            }
            
            .academy-logo {
                font-size: 3rem;
            }
            
            .tracker-title {
                font-size: 2rem;
            }
            
            .nav-btn {
                position: relative;
                margin: 0.5rem;
            }
            
            .tracker-header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Magical Background -->
    <div class="stars"></div>
    <div class="floating-sparkles"></div>

    <!-- Student Key Gate -->
    <div class="key-gate" id="keyGate">
        <div class="admission-letter">
            <h1 class="admission-title">🏰 HOGSWORTH ACADEMY</h1>
            <p class="admission-text">
                Welcome, aspiring wizard! Your acceptance letter has arrived.<br>
                Enter your student key to begin your magical nutrition journey.
            </p>
            <input type="text" 
                   class="key-input" 
                   id="studentKey" 
                   placeholder="Enter Student Key (WIZARD123)"
                   maxlength="20">
            <button class="enter-btn" onclick="enterAcademy()">🔮 Enter Academy</button>
            <div class="skip-link" onclick="skipToHouseSelection()">
                Continue as Guest Student
            </div>
        </div>
    </div>

    <!-- Welcome & House Selection -->
    <div class="welcome-page" id="welcomePage">
        <h1 class="academy-logo">⚡ HOGSWORTH ACADEMY ⚡</h1>
        <p class="academy-subtitle">Choose Your Magical House & Begin Your Journey</p>
        
        <div class="house-selection">
            <div class="house-crest serpent" onclick="selectHouse('serpent')">
                <div class="house-icon">
                    <div class="house-character">🐍</div>
                </div>
                <h3 class="house-name">SERPENT</h3>
                <p class="house-motto">"Ambition & Cunning"</p>
            </div>
            
            <div class="house-crest griffin" onclick="selectHouse('griffin')">
                <div class="house-icon">
                    <div class="house-character">🦅</div>
                </div>
                <h3 class="house-name">GRIFFIN</h3>
                <p class="house-motto">"Courage & Bravery"</p>
            </div>
            
            <div class="house-crest raven" onclick="selectHouse('raven')">
                <div class="house-icon">
                    <div class="house-character">🐦‍⬛</div>
                </div>
                <h3 class="house-name">RAVEN</h3>
                <p class="house-motto">"Wisdom & Intelligence"</p>
            </div>
            
            <div class="house-crest hufflecrest" onclick="selectHouse('hufflecrest')">
                <div class="house-icon">
                    <div class="house-character">🦡</div>
                </div>
                <h3 class="house-name">HUFFLECREST</h3>
                <p class="house-motto">"Loyalty & Hard Work"</p>
            </div>
        </div>
    </div>

    <!-- Main Tracker Page -->
    <div class="tracker-page" id="trackerPage">
        <div class="tracker-header">
            <button class="nav-btn goals-btn" onclick="openGoalsModal()">🎯 Goals</button>
            <button class="nav-btn chest-btn" onclick="openChestModal()">🏆 Chest</button>
            <button class="nav-btn week-btn" onclick="openWeekModal()">📊 Week</button>
            <button class="nav-btn customize-btn" onclick="openCustomizeModal()">⚙️ House</button>
            
            <h1 class="tracker-title" id="houseTitle">WYRNWICK ACADEMY</h1>
            <p class="house-welcome" id="houseWelcome">Welcome to your magical nutrition journey!</p>
            
            <div class="character-info">
                <span>🧙‍♂️ Level <span id="userLevel">1</span></span>
                <span>🎖️ <span id="userHouse">Wizard</span></span>
                <span>⭐ <span id="totalTrophies">0</span> Trophies</span>
            </div>
            
            <div class="streak-info">
                <span>🔥 <span id="currentStreak">0</span> Day Streak</span>
                <span>💪 <span id="longestStreak">0</span> Best Streak</span>
            </div>
            
            <div class="xp-container">
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <div class="xp-text">
                    <span id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP
                </div>
            </div>
        </div>

        <div class="tracker-content">
            <!-- Food Tracker Card -->
            <div class="magical-card">
                <h2 class="card-title">🍎 Nutrition Tracker</h2>
                
                <div class="input-group">
                    <div class="input-row">
                        <input type="text" 
                               class="magical-input" 
                               id="foodSearch" 
                               placeholder="Search food (e.g., chicken, apple, oats)"
                               onkeyup="searchFood()"
                               aria-live="polite">
                    </div>
                    <div class="suggest-dropdown" id="suggestDropdown" style="display: none;"></div>
                </div>

                <div class="input-group">
                    <div class="input-row">
                        <input type="number" 
                               class="magical-input" 
                               id="foodAmount" 
                               placeholder="Amount"
                               step="0.1"
                               min="0.1"
                               value="100"
                               oninput="updateNutritionPreview()">
                        <select class="magical-select" id="foodUnit" onchange="updateNutritionPreview()">
                            <option value="g">g</option>
                            <option value="oz">oz</option>
                            <option value="cup">cup</option>
                            <option value="tbsp">tbsp</option>
                            <option value="slice">slice</option>
                            <option value="piece">piece</option>
                        </select>
                    </div>
                </div>

                <div class="nutrition-preview" id="nutritionPreview" aria-live="polite">
                    <div class="preview-title">🔮 Nutrition Preview</div>
                    <div class="preview-macros">
                        <div class="preview-macro">
                            <div class="preview-value" id="previewCals">0</div>
                            <div class="preview-label">Calories</div>
                        </div>
                        <div class="preview-macro">
                            <div class="preview-value" id="previewProtein">0g</div>
                            <div class="preview-label">Protein</div>
                        </div>
                        <div class="preview-macro">
                            <div class="preview-value" id="previewCarbs">0g</div>
                            <div class="preview-label">Carbs</div>
                        </div>
                        <div class="preview-macro">
                            <div class="preview-value" id="previewFat">0g</div>
                            <div class="preview-label">Fat</div>
                        </div>
                    </div>
                </div>

                <div class="input-row">
                    <button class="magical-btn" onclick="addFood()">⚡ Add to Log</button>
                    <button class="magical-btn secondary" onclick="openCustomFood()" style="margin-left: 0.5rem;">➕ Custom</button>
                </div>

                <div class="food-log" id="foodLog">
                    <!-- Food items will appear here -->
                </div>
            </div>

            <!-- Progress & Goals Card -->
            <div class="magical-card">
                <h2 class="card-title">🎯 Daily Progress</h2>
                
                <div class="goals-container">
                    <div class="calorie-ring">
                        <div class="ring-bg"></div>
                        <div class="ring-fill" id="calorieRing"></div>
                        <div class="ring-text">
                            <div class="ring-calories" id="currentCals">0</div>
                            <div class="ring-remaining" id="remainingCals">2000 left</div>
                        </div>
                    </div>
                    
                    <div class="macro-bars">
                        <div class="macro-bar">
                            <div class="macro-name">💪 Protein</div>
                            <div class="macro-progress">
                                <div class="macro-fill protein-fill" id="proteinBar" style="width: 0%"></div>
                            </div>
                            <div class="macro-text" id="proteinText">0g / 150g</div>
                        </div>
                        
                        <div class="macro-bar">
                            <div class="macro-name">🌾 Carbs</div>
                            <div class="macro-progress">
                                <div class="macro-fill carbs-fill" id="carbsBar" style="width: 0%"></div>
                            </div>
                            <div class="macro-text" id="carbsText">0g / 250g</div>
                        </div>
                        
                        <div class="macro-bar">
                            <div class="macro-name">🥑 Fat</div>
                            <div class="macro-progress">
                                <div class="macro-fill fat-fill" id="fatBar" style="width: 0%"></div>
                            </div>
                            <div class="macro-text" id="fatText">0g / 67g</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals Modal -->
    <div class="modal" id="goalsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🎯 Set Your Goals</h2>
                <button class="close-btn" onclick="closeModal('goalsModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Age:</label>
                <input type="number" class="magical-input" id="userAge" value="25">
            </div>
            <div class="input-group">
                <label>Gender:</label>
                <select class="magical-select" id="userGender" style="width: 100%;">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Weight (kg):</label>
                <input type="number" class="magical-input" id="userWeight" value="70" step="0.1">
            </div>
            <div class="input-group">
                <label>Height (cm):</label>
                <input type="number" class="magical-input" id="userHeight" value="175">
            </div>
            <div class="input-group">
                <label>Activity Level:</label>
                <select class="magical-select" id="activityLevel" style="width: 100%;">
                    <option value="1.2">Sedentary (little/no exercise)</option>
                    <option value="1.375">Lightly active (light exercise 1-3 days/week)</option>
                    <option value="1.55" selected>Moderately active (moderate exercise 3-5 days/week)</option>
                    <option value="1.725">Very active (hard exercise 6-7 days/week)</option>
                    <option value="1.9">Extremely active (very hard exercise/job)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Goal:</label>
                <select class="magical-select" id="userGoal" style="width: 100%;">
                    <option value="lose">Fat Loss (-500 calories)</option>
                    <option value="maintain" selected>Maintain Weight</option>
                    <option value="gain">Muscle Gain (+300 calories)</option>
                </select>
            </div>
            <button class="magical-btn" onclick="calculateGoals()">⚡ Calculate My Goals</button>
        </div>
    </div>

    <!-- Trophy Chest Modal -->
    <div class="modal" id="chestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🏆 Wizard's Trophy Chest</h2>
                <button class="close-btn" onclick="closeModal('chestModal')">&times;</button>
            </div>
            <div class="chest-grid" id="chestGrid">
                <!-- Trophies will be populated here -->
            </div>
        </div>
    </div>

    <!-- Week Overview Modal -->
    <div class="modal" id="weekModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📊 Weekly Overview</h2>
                <button class="close-btn" onclick="closeModal('weekModal')">&times;</button>
            </div>
            <div id="weekContent">
                <!-- Week data will be populated here -->
            </div>
        </div>
    </div>

    <!-- House Customize Modal -->
    <div class="modal" id="customizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⚙️ House Selection</h2>
                <button class="close-btn" onclick="closeModal('customizeModal')">&times;</button>
            </div>
            <div class="house-selection">
                <div class="house-crest serpent" onclick="changeHouse('serpent')">
                    <div class="house-icon">
                        <div class="house-character">🐍</div>
                    </div>
                    <h3 class="house-name">SERPENT</h3>
                    <p class="house-motto">"Ambition & Cunning"</p>
                </div>
                
                <div class="house-crest griffin" onclick="changeHouse('griffin')">
                    <div class="house-icon">
                        <div class="house-character">🦅</div>
                    </div>
                    <h3 class="house-name">GRIFFIN</h3>
                    <p class="house-motto">"Courage & Bravery"</p>
                </div>
                
                <div class="house-crest raven" onclick="changeHouse('raven')">
                    <div class="house-icon">
                        <div class="house-character">🐦‍⬛</div>
                    </div>
                    <h3 class="house-name">RAVEN</h3>
                    <p class="house-motto">"Wisdom & Intelligence"</p>
                </div>
                
                <div class="house-crest hufflecrest" onclick="changeHouse('hufflecrest')">
                    <div class="house-icon">
                        <div class="house-character">🦡</div>
                    </div>
                    <h3 class="house-name">HUFFLECREST</h3>
                    <p class="house-motto">"Loyalty & Hard Work"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div class="modal" id="editMealModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">✏️ Edit Entry</h2>
                <button class="close-btn" onclick="closeEditMeal()">&times;</button>
            </div>
            <div id="editMealName" style="text-align:center;color:var(--secondary);font-size:1.2rem;margin-bottom:1rem;"></div>
            <div class="input-group">
                <input id="editQty" type="number" class="magical-input" step="0.1" min="0.1" placeholder="Quantity">
            </div>
            <div class="input-group">
                <select id="editUnit" class="magical-select" style="width: 100%;">
                    <option value="g">grams</option>
                    <option value="oz">oz</option>
                    <option value="cup">cup</option>
                    <option value="tbsp">tbsp</option>
                    <option value="slice">slice</option>
                    <option value="piece">piece</option>
                </select>
            </div>
            <button class="magical-btn" onclick="saveMealEdit()">💾 Save Changes</button>
        </div>
    </div>

    <!-- Custom Food Modal -->
    <div class="modal" id="customFoodModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🍽️ Create Custom Food</h2>
                <button class="close-btn" onclick="closeCustomFood()">&times;</button>
            </div>
            <div class="input-group">
                <input id="cfName" class="magical-input" placeholder="Food Name">
            </div>
            <div class="input-row">
                <input id="cfPer" class="magical-input" value="100g" placeholder="Per (e.g., 100g)">
                <input id="cfKcal" class="magical-input" type="number" placeholder="Calories">
            </div>
            <div class="input-row">
                <input id="cfP" class="magical-input" type="number" placeholder="Protein (g)">
                <input id="cfC" class="magical-input" type="number" placeholder="Carbs (g)">
            </div>
            <div class="input-row">
                <input id="cfF" class="magical-input" type="number" placeholder="Fat (g)">
            </div>
            <div class="input-group">
                <input id="cfAlias" class="magical-input" placeholder="Aliases (comma-separated)">
            </div>
            <button class="magical-btn" onclick="saveCustomFood()">⚡ Create Food</button>
        </div>
    </div>

    <script>
        // Enhanced Game State Management
        let gameState = {
            currentHouse: '',
            level: 1,
            xp: 0,
            streak: 0,
            longestStreak: 0,
            trophies: [],
            dailyLog: [],
            goals: {
                calories: 2000,
                protein: 150,
                carbs: 250,
                fat: 67
            },
            weeklyData: [],
            customFoods: [],
            favoriteFoods: [],
            recentFoods: []
        };

        // Enhanced Food Database with IDs and more foods
        let FOODS_CATALOG = [
            // Proteins
            { id: 'chicken_breast', name: 'Chicken Breast', cals: 165, protein: 31, carbs: 0, fat: 3.6, per: '100g', aliases: ['chicken'] },
            { id: 'salmon', name: 'Salmon', cals: 208, protein: 22, carbs: 0, fat: 12, per: '100g' },
            { id: 'tuna', name: 'Tuna', cals: 132, protein: 28, carbs: 0, fat: 1, per: '100g' },
            { id: 'eggs', name: 'Eggs', cals: 155, protein: 13, carbs: 1.1, fat: 11, per: '100g', aliases: ['egg'] },
            { id: 'greek_yogurt', name: 'Greek Yogurt', cals: 59, protein: 10, carbs: 3.6, fat: 0.4, per: '100g' },
            { id: 'cottage_cheese', name: 'Cottage Cheese', cals: 98, protein: 11, carbs: 3.4, fat: 4.3, per: '100g' },
            { id: 'lean_beef', name: 'Lean Beef', cals: 250, protein: 26, carbs: 0, fat: 15, per: '100g' },
            { id: 'turkey', name: 'Turkey', cals: 135, protein: 30, carbs: 0, fat: 1, per: '100g' },
            { id: 'tofu', name: 'Tofu', cals: 76, protein: 8, carbs: 1.9, fat: 4.8, per: '100g' },
            
            // Carbs
            { id: 'brown_rice', name: 'Brown Rice', cals: 111, protein: 2.6, carbs: 23, fat: 0.9, per: '100g' },
            { id: 'white_rice', name: 'White Rice', cals: 130, protein: 2.7, carbs: 28, fat: 0.3, per: '100g', aliases: ['rice'] },
            { id: 'oats', name: 'Oats', cals: 389, protein: 16.9, carbs: 66, fat: 6.9, per: '100g' },
            { id: 'oatmeal', name: 'Oatmeal', cals: 68, protein: 2.4, carbs: 12, fat: 1.4, per: '100g' },
            { id: 'quinoa', name: 'Quinoa', cals: 120, protein: 4.4, carbs: 22, fat: 1.9, per: '100g' },
            { id: 'sweet_potato', name: 'Sweet Potato', cals: 86, protein: 1.6, carbs: 20, fat: 0.1, per: '100g' },
            { id: 'potato', name: 'Potato', cals: 77, protein: 2, carbs: 17, fat: 0.1, per: '100g' },
            { id: 'pasta', name: 'Pasta', cals: 131, protein: 5, carbs: 25, fat: 1.1, per: '100g' },
            { id: 'bread', name: 'Bread', cals: 265, protein: 9, carbs: 49, fat: 3.2, per: '100g' },
            { id: 'banana', name: 'Banana', cals: 89, protein: 1.1, carbs: 23, fat: 0.3, per: '100g' },
            
            // Fats
            { id: 'avocado', name: 'Avocado', cals: 160, protein: 2, carbs: 9, fat: 15, per: '100g' },
            { id: 'almonds', name: 'Almonds', cals: 579, protein: 21, carbs: 22, fat: 50, per: '100g', aliases: ['nuts'] },
            { id: 'olive_oil', name: 'Olive Oil', cals: 884, protein: 0, carbs: 0, fat: 100, per: '100g' },
            { id: 'peanut_butter', name: 'Peanut Butter', cals: 588, protein: 25, carbs: 20, fat: 50, per: '100g', aliases: ['pb'] },
            { id: 'walnuts', name: 'Walnuts', cals: 654, protein: 15, carbs: 14, fat: 65, per: '100g' },
            { id: 'coconut_oil', name: 'Coconut Oil', cals: 862, protein: 0, carbs: 0, fat: 100, per: '100g' },
            { id: 'butter', name: 'Butter', cals: 717, protein: 0.9, carbs: 0.1, fat: 81, per: '100g' },
            
            // Vegetables
            { id: 'broccoli', name: 'Broccoli', cals: 34, protein: 2.8, carbs: 7, fat: 0.4, per: '100g' },
            { id: 'spinach', name: 'Spinach', cals: 23, protein: 2.9, carbs: 3.6, fat: 0.4, per: '100g' },
            { id: 'carrots', name: 'Carrots', cals: 41, protein: 0.9, carbs: 10, fat: 0.2, per: '100g' },
            { id: 'tomato', name: 'Tomato', cals: 18, protein: 0.9, carbs: 3.9, fat: 0.2, per: '100g' },
            { id: 'cucumber', name: 'Cucumber', cals: 16, protein: 0.7, carbs: 4, fat: 0.1, per: '100g' },
            
            // Fruits
            { id: 'apple', name: 'Apple', cals: 52, protein: 0.3, carbs: 14, fat: 0.2, per: '100g' },
            { id: 'orange', name: 'Orange', cals: 47, protein: 0.9, carbs: 12, fat: 0.1, per: '100g' },
            { id: 'strawberries', name: 'Strawberries', cals: 32, protein: 0.7, carbs: 8, fat: 0.3, per: '100g' },
            { id: 'blueberries', name: 'Blueberries', cals: 57, protein: 0.7, carbs: 14, fat: 0.3, per: '100g' },
            
            // Dairy
            { id: 'milk', name: 'Milk', cals: 42, protein: 3.4, carbs: 5, fat: 1, per: '100g' },
            { id: 'cheese', name: 'Cheese', cals: 402, protein: 25, carbs: 1.3, fat: 33, per: '100g' },
            { id: 'yogurt', name: 'Yogurt', cals: 59, protein: 10, carbs: 3.6, fat: 0.4, per: '100g' }
        ];

        // Trophy System
        const trophySystem = {
            'first-meal': { name: 'First Meal', icon: '🍽️', desc: 'Log your first meal', condition: () => gameState.dailyLog.length >= 1 },
            'macro-master': { name: 'Macro Master', icon: '⚖️', desc: 'Hit all macro targets in one day', condition: () => checkMacroTargets() },
            'calorie-king': { name: 'Calorie King', icon: '👑', desc: 'Reach calorie goal', condition: () => getCurrentCals() >= gameState.goals.calories * 0.95 },
            'protein-power': { name: 'Protein Power', icon: '💪', desc: 'Hit protein target', condition: () => getCurrentProtein() >= gameState.goals.protein * 0.95 },
            'streak-star': { name: 'Streak Star', icon: '🔥', desc: 'Maintain 7-day streak', condition: () => gameState.streak >= 7 },
            'level-legend': { name: 'Level Legend', icon: '🌟', desc: 'Reach level 5', condition: () => gameState.level >= 5 },
            'house-hero': { name: 'House Hero', icon: '🏆', desc: 'Choose your house', condition: () => gameState.currentHouse !== '' },
            'nutrition-ninja': { name: 'Nutrition Ninja', icon: '🥷', desc: 'Log 50 meals', condition: () => getTotalMealsLogged() >= 50 },
            'potion-master': { name: 'Potion Master', icon: '🧪', desc: 'Use all food categories', condition: () => checkFoodVariety() },
            'zen-master': { name: 'Zen Master', icon: '🧘', desc: 'Perfect week (7 days on target)', condition: () => checkPerfectWeek() },
            'challenge-champion': { name: 'Challenge Champion', icon: '🏅', desc: 'Complete 10 weekly challenges', condition: () => getChallengesCompleted() >= 10 },
            'ultimate-wizard': { name: 'Ultimate Wizard', icon: '🧙‍♂️', desc: 'Unlock all other trophies', condition: () => gameState.trophies.length >= 11 }
        };

        // Unit Conversion System
        const unitConversions = {
            'g': 1,
            'oz': 28.35,
            'cup': 240,
            'tbsp': 15,
            'slice': 30,
            'piece': 50
        };

        // Global Variables
        let selectedFood = null;
        let editingMealId = null;
        let selectedFoodId = null;

        // Utility Functions
        const debounce = (fn, ms = 150) => {
            let t;
            return (...a) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...a), ms);
            }
        };

        const iso = (d = new Date()) => d.toISOString().slice(0, 10);

        // Initialize the app
        function init() {
            createStars();
            createFloatingSparkles();
            loadGameState();
            setupFoodSearch();
            document.getElementById('studentKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enterAcademy();
                }
            });
        }

        // Create magical background effects
        function createStars() {
            const starsContainer = document.querySelector('.stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        function createFloatingSparkles() {
            const sparklesContainer = document.querySelector('.floating-sparkles');
            for (let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 6 + 's';
                sparkle.style.animationDuration = (4 + Math.random() * 4) + 's';
                sparklesContainer.appendChild(sparkle);
            }
        }

        // Enhanced Food Search System
        function setupFoodSearch() {
            const input = document.getElementById('foodSearch');
            const dropdown = document.getElementById('suggestDropdown');
            
            input.addEventListener('input', debounce(function() {
                const value = input.value.toLowerCase().trim();
                if (value.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                showSuggestions(value);
            }, 160));
            
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && selectedFoodId) {
                    addFood();
                    e.preventDefault();
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function showSuggestions(query) {
            const dropdown = document.getElementById('suggestDropdown');
            
            // Get favorites first, then recent foods, then all foods
            const favorites = gameState.favoriteFoods.map(id => FOODS_CATALOG.find(f => f.id === id)).filter(Boolean);
            const recents = gameState.recentFoods.map(id => FOODS_CATALOG.find(f => f.id === id)).filter(Boolean);
            const allFoods = FOODS_CATALOG;
            
            // Create ordered list prioritizing favorites and recents
            const orderedFoods = [
                ...favorites.filter(food => matchesQuery(food, query)),
                ...recents.filter(food => matchesQuery(food, query) && !favorites.some(f => f.id === food.id)),
                ...allFoods.filter(food => matchesQuery(food, query) && !favorites.some(f => f.id === food.id) && !recents.some(r => r.id === food.id))
            ];
            
            const suggestions = orderedFoods.slice(0, 8);
            
            if (suggestions.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = suggestions.map(food => `
                <div class="suggest-item">
                    <div onclick="selectFood('${food.id}')" style="flex: 1;">
                        <div class="suggest-food-name">${food.name} ${isFavorite(food.id) ? '⭐' : ''}</div>
                        <div class="suggest-food-info">${food.cals} cal • ${food.protein}p • ${food.carbs}c • ${food.fat}f per ${food.per}</div>
                    </div>
                    <div style="margin-left: 10px;">
                        <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite('${food.id}'); updateSuggestionsList();">${isFavorite(food.id) ? '★' : '☆'}</button>
                    </div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function matchesQuery(food, query) {
            const searchTerms = [food.name.toLowerCase(), ...(food.aliases || [])];
            return searchTerms.some(term => term.includes(query));
        }

        function selectFood(foodId) {
            selectedFoodId = foodId;
            const food = FOODS_CATALOG.find(f => f.id === foodId);
            if (food) {
                document.getElementById('foodSearch').value = food.name;
                document.getElementById('suggestDropdown').style.display = 'none';
                updateNutritionPreview();
                
                // Add to recent foods
                addToRecents(foodId);
            }
        }

        function addToRecents(foodId) {
            gameState.recentFoods = gameState.recentFoods.filter(id => id !== foodId);
            gameState.recentFoods.unshift(foodId);
            gameState.recentFoods = gameState.recentFoods.slice(0, 10);
            saveGameState();
        }

        // Favorites System
        function toggleFavorite(foodId) {
            const index = gameState.favoriteFoods.indexOf(foodId);
            if (index > -1) {
                gameState.favoriteFoods.splice(index, 1);
            } else {
                gameState.favoriteFoods.unshift(foodId);
                gameState.favoriteFoods = gameState.favoriteFoods.slice(0, 50);
            }
            saveGameState();
        }

        function isFavorite(foodId) {
            return gameState.favoriteFoods.includes(foodId);
        }

        function updateSuggestionsList() {
            const query = document.getElementById('foodSearch').value.toLowerCase().trim();
            if (query.length >= 2) {
                showSuggestions(query);
            }
        }

        // Custom Food System
        function openCustomFood() {
            document.getElementById('customFoodModal').style.display = 'block';
        }

        function closeCustomFood() {
            document.getElementById('customFoodModal').style.display = 'none';
            // Clear form
            document.getElementById('cfName').value = '';
            document.getElementById('cfPer').value = '100g';
            document.getElementById('cfKcal').value = '';
            document.getElementById('cfP').value = '';
            document.getElementById('cfC').value = '';
            document.getElementById('cfF').value = '';
            document.getElementById('cfAlias').value = '';
        }

        function saveCustomFood() {
            const name = document.getElementById('cfName').value.trim();
            const per = document.getElementById('cfPer').value.trim() || '100g';
            const cals = parseFloat(document.getElementById('cfKcal').value) || 0;
            const protein = parseFloat(document.getElementById('cfP').value) || 0;
            const carbs = parseFloat(document.getElementById('cfC').value) || 0;
            const fat = parseFloat(document.getElementById('cfF').value) || 0;
            const aliasStr = document.getElementById('cfAlias').value || '';
            const aliases = aliasStr.split(',').map(s => s.trim()).filter(Boolean);
            
            if (!name || !per) {
                showToast('Please fill in name and per fields!', 'error');
                return;
            }
            
            const id = 'custom_' + Date.now();
            const customFood = { id, name, per, cals, protein, carbs, fat, aliases };
            
            // Add to game state and catalog
            gameState.customFoods.push(customFood);
            FOODS_CATALOG.push(customFood);
            
            closeCustomFood();
            showToast(`Created ${name}! You can now search for it. ✨`, 'success');
            saveGameState();
        }

        // Entry system functions
        function enterAcademy() {
            const key = document.getElementById('studentKey').value.trim().toUpperCase();
            const validKeys = ['WIZARD123', 'MAGIC', 'ACADEMY', 'STUDENT'];
            
            if (validKeys.includes(key) || key === '') {
                showToast('Welcome to Hogsworth Academy! 🏰✨', 'success');
                setTimeout(() => {
                    document.getElementById('keyGate').style.display = 'none';
                    document.getElementById('welcomePage').style.display = 'flex';
                }, 1000);
            } else {
                showToast('Invalid student key! Try WIZARD123 or continue as guest.', 'error');
                document.getElementById('studentKey').style.animation = 'shake 0.5s ease';
                setTimeout(() => {
                    document.getElementById('studentKey').style.animation = '';
                }, 500);
            }
        }

        function skipToHouseSelection() {
            showToast('Welcome, Guest Student! 🎓', 'success');
            setTimeout(() => {
                document.getElementById('keyGate').style.display = 'none';
                document.getElementById('welcomePage').style.display = 'flex';
            }, 1000);
        }

        function selectHouse(house) {
            gameState.currentHouse = house;
            document.body.className = house;
            
            // Award house hero trophy
            awardTrophy('house-hero');
            
            showToast(`Welcome to ${house.charAt(0).toUpperCase() + house.slice(1)}! 🏆`, 'success');
            
            setTimeout(() => {
                document.getElementById('welcomePage').style.display = 'none';
                document.getElementById('trackerPage').style.display = 'block';
                updateHouseDisplay();
                updateDisplay();
            }, 1500);
            
            saveGameState();
        }

        function changeHouse(house) {
            selectHouse(house);
            closeModal('customizeModal');
        }

        // Display update functions
        function updateHouseDisplay() {
            const houseNames = {
                'serpent': 'SERPENT HOUSE',
                'griffin': 'GRIFFIN HOUSE', 
                'raven': 'RAVEN HOUSE',
                'hufflecrest': 'HUFFLECREST HOUSE'
            };
            
            const houseWelcomes = {
                'serpent': 'Ambitious and cunning nutrition mastery 🐍',
                'griffin': 'Brave the path to legendary fitness 🦅',
                'raven': 'Wise choices for optimal wellness 🐦‍⬛', 
                'hufflecrest': 'Dedicated progress through loyal effort 🦡'
            };
            
            document.getElementById('houseTitle').textContent = houseNames[gameState.currentHouse] || 'HOGSWORTH ACADEMY';
            document.getElementById('houseWelcome').textContent = houseWelcomes[gameState.currentHouse] || 'Welcome to your magical nutrition journey!';
            document.getElementById('userHouse').textContent = gameState.currentHouse.charAt(0).toUpperCase() + gameState.currentHouse.slice(1);
        }

        function updateDisplay() {
            // Update character info
            document.getElementById('userLevel').textContent = gameState.level;
            document.getElementById('totalTrophies').textContent = gameState.trophies.length;
            document.getElementById('currentStreak').textContent = gameState.streak;
            document.getElementById('longestStreak').textContent = gameState.longestStreak;
            
            // Update XP bar
            const xpNeeded = gameState.level * 100;
            const xpProgress = (gameState.xp / xpNeeded) * 100;
            document.getElementById('xpFill').style.width = xpProgress + '%';
            document.getElementById('currentXP').textContent = gameState.xp;
            document.getElementById('nextLevelXP').textContent = xpNeeded;
            
            // Update nutrition display
            updateNutritionDisplay();
            updateFoodLog();
        }

        function updateNutritionDisplay() {
            const currentCals = getCurrentCals();
            const currentProtein = getCurrentProtein();
            const currentCarbs = getCurrentCarbs();
            const currentFat = getCurrentFat();
            
            // Update calorie ring with smooth conic gradient
            const pct = Math.min(currentCals / gameState.goals.calories, 1);
            const calorieRing = document.getElementById('calorieRing');
            calorieRing.style.background = `conic-gradient(var(--secondary) ${pct * 360}deg, rgba(255,255,255,.18) 0deg)`;
            
            document.getElementById('currentCals').textContent = Math.round(currentCals);
            document.getElementById('remainingCals').textContent = Math.max(0, Math.round(gameState.goals.calories - currentCals)) + ' left';
            
            // Update macro bars
            const proteinProgress = Math.min((currentProtein / gameState.goals.protein) * 100, 100);
            const carbsProgress = Math.min((currentCarbs / gameState.goals.carbs) * 100, 100);
            const fatProgress = Math.min((currentFat / gameState.goals.fat) * 100, 100);
            
            document.getElementById('proteinBar').style.width = proteinProgress + '%';
            document.getElementById('carbsBar').style.width = carbsProgress + '%';
            document.getElementById('fatBar').style.width = fatProgress + '%';
            
            document.getElementById('proteinText').textContent = `${Math.round(currentProtein)}g / ${gameState.goals.protein}g`;
            document.getElementById('carbsText').textContent = `${Math.round(currentCarbs)}g / ${gameState.goals.carbs}g`;
            document.getElementById('fatText').textContent = `${Math.round(currentFat)}g / ${gameState.goals.fat}g`;
        }

        // Food tracking functions
        function searchFood() {
            // This is now handled by the enhanced search system
            updateNutritionPreview();
        }

        function updateNutritionPreview() {
            if (!selectedFoodId) {
                document.getElementById('previewCals').textContent = '0';
                document.getElementById('previewProtein').textContent = '0g';
                document.getElementById('previewCarbs').textContent = '0g';
                document.getElementById('previewFat').textContent = '0g';
                return;
            }
            
            const food = FOODS_CATALOG.find(f => f.id === selectedFoodId);
            const amount = parseFloat(document.getElementById('foodAmount').value) || 0;
            const unit = document.getElementById('foodUnit').value;
            
            if (food && amount > 0) {
                const nutrition = calculateNutrition(food, amount, unit);
                
                document.getElementById('previewCals').textContent = Math.round(nutrition.calories);
                document.getElementById('previewProtein').textContent = nutrition.protein.toFixed(1) + 'g';
                document.getElementById('previewCarbs').textContent = nutrition.carbs.toFixed(1) + 'g';
                document.getElementById('previewFat').textContent = nutrition.fat.toFixed(1) + 'g';
                
                // Store current food data for adding
                window.currentFoodPreview = {
                    foodId: selectedFoodId,
                    name: food.name,
                    amount: amount,
                    unit: unit,
                    nutrition: nutrition
                };
            }
        }

        function calculateNutrition(food, quantity, unit) {
            // Convert to grams first
            const gramsAmount = quantity * unitConversions[unit];
            
            // Calculate per 100g
            const multiplier = gramsAmount / 100;
            
            return {
                calories: food.cals * multiplier,
                protein: food.protein * multiplier,
                carbs: food.carbs * multiplier,
                fat: food.fat * multiplier
            };
        }

        function addFood() {
            if (!window.currentFoodPreview) {
                showToast('Please search and select a food first!', 'error');
                return;
            }
            
            const foodEntry = {
                ...window.currentFoodPreview,
                id: Date.now(),
                timestamp: new Date().toISOString(),
                date: iso()
            };
            
            gameState.dailyLog.push(foodEntry);
            
            // Award XP and check for level up
            addXP(10);
            
            // Add to recent foods
            addToRecents(foodEntry.foodId);
            
            // Check for trophies
            checkAndAwardTrophies();
            
            // Update display
            updateDisplay();
            
            // Clear inputs
            document.getElementById('foodSearch').value = '';
            document.getElementById('foodAmount').value = '100';
            document.getElementById('foodUnit').value = 'g';
            selectedFoodId = null;
            updateNutritionPreview();
            
            showToast(`Added ${foodEntry.name}! +10 XP 🎉`, 'success');
            saveGameState();
        }

        function updateFoodLog() {
            const foodLog = document.getElementById('foodLog');
            foodLog.innerHTML = '';
            
            // Show today's foods in reverse order (newest first)
            const todaysFoods = getTodaysFoods().reverse();
            
            todaysFoods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.innerHTML = `
                    <div class="food-details">
                        <div class="food-name">${food.name} (${food.amount}${food.unit})</div>
                        <div class="food-macros">${Math.round(food.nutrition.calories)} cal • ${food.nutrition.protein.toFixed(1)}g protein • ${food.nutrition.carbs.toFixed(1)}g carbs • ${food.nutrition.fat.toFixed(1)}g fat</div>
                    </div>
                    <div class="food-actions">
                        <button class="action-btn" onclick="openEditMeal(${food.id})">✏️</button>
                        <button class="action-btn" onclick="deleteFood(${food.id})">🗑️</button>
                    </div>
                `;
                foodLog.appendChild(foodItem);
            });
            
            if (todaysFoods.length === 0) {
                foodLog.innerHTML = '<div style="text-align: center; color: #ccc; padding: 2rem;">No foods logged today. Start tracking! 🍽️</div>';
            }
        }

        // Edit Meal System
        function openEditMeal(mealId) {
            const meal = gameState.dailyLog.find(m => m.id === mealId);
            if (!meal) return;
            
            editingMealId = mealId;
            document.getElementById('editMealName').textContent = meal.name;
            document.getElementById('editQty').value = meal.amount;
            document.getElementById('editUnit').value = meal.unit;
            document.getElementById('editMealModal').style.display = 'block';
        }

        function closeEditMeal() {
            document.getElementById('editMealModal').style.display = 'none';
            editingMealId = null;
        }

        function saveMealEdit() {
            if (!editingMealId) return;
            
            const mealIndex = gameState.dailyLog.findIndex(m => m.id === editingMealId);
            if (mealIndex === -1) return;
            
            const meal = gameState.dailyLog[mealIndex];
            const newQuantity = parseFloat(document.getElementById('editQty').value) || meal.amount;
            const newUnit = document.getElementById('editUnit').value || meal.unit;
            
            // Get food from catalog
            const food = FOODS_CATALOG.find(f => f.id === meal.foodId);
            if (!food) return;
            
            // Calculate new nutrition
            const newNutrition = calculateNutrition(food, newQuantity, newUnit);
            
            // Update meal
            gameState.dailyLog[mealIndex] = {
                ...meal,
                amount: newQuantity,
                unit: newUnit,
                nutrition: newNutrition
            };
            
            updateDisplay();
            closeEditMeal();
            showToast('Meal updated! ✨', 'success');
            saveGameState();
        }

        function deleteFood(foodId) {
            const index = gameState.dailyLog.findIndex(food => food.id === foodId);
            if (index !== -1) {
                const deletedFood = gameState.dailyLog[index];
                gameState.dailyLog.splice(index, 1);
                updateDisplay();
                showToast(`Removed ${deletedFood.name}`, 'success');
                saveGameState();
            }
        }

        // Calculation functions with ISO dates
        function getCurrentCals() {
            return getTodaysFoods().reduce((total, food) => total + food.nutrition.calories, 0);
        }

        function getCurrentProtein() {
            return getTodaysFoods().reduce((total, food) => total + food.nutrition.protein, 0);
        }

        function getCurrentCarbs() {
            return getTodaysFoods().reduce((total, food) => total + food.nutrition.carbs, 0);
        }

        function getCurrentFat() {
            return getTodaysFoods().reduce((total, food) => total + food.nutrition.fat, 0);
        }

        function getTodaysFoods() {
            const today = iso();
            return gameState.dailyLog.filter(food => food.date === today);
        }

        function getTotalMealsLogged() {
            return gameState.dailyLog.length;
        }

        // XP and Level System
        function addXP(amount) {
            gameState.xp += amount;
            const xpNeeded = gameState.level * 100;
            
            if (gameState.xp >= xpNeeded) {
                gameState.level++;
                gameState.xp = 0;
                showToast(`Level Up! You're now level ${gameState.level}! 🌟`, 'success');
                checkAndAwardTrophies();
            }
        }

        // Trophy System
        function checkAndAwardTrophies() {
            Object.keys(trophySystem).forEach(trophyId => {
                if (!gameState.trophies.includes(trophyId)) {
                    const trophy = trophySystem[trophyId];
                    if (trophy.condition()) {
                        awardTrophy(trophyId);
                    }
                }
            });
        }

        function awardTrophy(trophyId) {
            if (!gameState.trophies.includes(trophyId)) {
                gameState.trophies.push(trophyId);
                const trophy = trophySystem[trophyId];
                showToast(`🏆 Trophy Unlocked: ${trophy.name}! +50 XP`, 'success');
                addXP(50);
                saveGameState();
            }
        }

        function checkMacroTargets() {
            const cals = getCurrentCals();
            const protein = getCurrentProtein();
            const carbs = getCurrentCarbs();
            const fat = getCurrentFat();
            
            return cals >= gameState.goals.calories * 0.95 &&
                   protein >= gameState.goals.protein * 0.95 &&
                   carbs >= gameState.goals.carbs * 0.95 &&
                   fat >= gameState.goals.fat * 0.95;
        }

        function checkFoodVariety() {
            return gameState.dailyLog.length >= 20;
        }

        function checkPerfectWeek() {
            return gameState.streak >= 7;
        }

        function getChallengesCompleted() {
            return Math.floor(gameState.dailyLog.length / 10);
        }

        // Modal functions
        function openGoalsModal() {
            document.getElementById('goalsModal').style.display = 'block';
        }

        function openChestModal() {
            populateChest();
            document.getElementById('chestModal').style.display = 'block';
        }

        function openWeekModal() {
            populateWeekOverview();
            document.getElementById('weekModal').style.display = 'block';
        }

        function openCustomizeModal() {
            document.getElementById('customizeModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function populateChest() {
            const chestGrid = document.getElementById('chestGrid');
            chestGrid.innerHTML = '';
            
            Object.entries(trophySystem).forEach(([trophyId, trophy]) => {
                const trophyElement = document.createElement('div');
                const isEarned = gameState.trophies.includes(trophyId);
                
                trophyElement.className = `trophy ${isEarned ? 'earned' : ''}`;
                trophyElement.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${trophy.icon}</div>
                    <div style="font-weight: bold; font-size: 0.8rem; margin-bottom: 0.3rem;">${trophy.name}</div>
                    <div style="font-size: 0.7rem; color: #ccc;">${trophy.desc}</div>
                `;
                
                if (isEarned) {
                    trophyElement.style.opacity = '1';
                } else {
                    trophyElement.style.opacity = '0.3';
                }
                
                chestGrid.appendChild(trophyElement);
            });
        }

        function populateWeekOverview() {
            const weekContent = document.getElementById('weekContent');
            weekContent.innerHTML = '<div style="text-align: center; padding: 2rem;">📊 Weekly tracking coming soon! Keep logging to build your history.</div>';
        }

        function calculateGoals() {
            const age = parseInt(document.getElementById('userAge').value);
            const gender = document.getElementById('userGender').value;
            const weight = parseFloat(document.getElementById('userWeight').value);
            const height = parseInt(document.getElementById('userHeight').value);
            const activity = parseFloat(document.getElementById('activityLevel').value);
            const goal = document.getElementById('userGoal').value;
            
            // Calculate BMR using Mifflin-St Jeor Equation
            let bmr;
            if (gender === 'male') {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }
            
            // Calculate TDEE
            let tdee = bmr * activity;
            
            // Adjust for goal
            if (goal === 'lose') {
                tdee -= 500;
            } else if (goal === 'gain') {
                tdee += 300;
            }
            
            // Calculate macros
            const protein = Math.round(weight * 1.8); // 1.8g per kg
            const calories = Math.round(tdee);
            const fat = Math.round(calories * 0.25 / 9); // 25% of calories from fat
            const carbs = Math.round((calories - (protein * 4) - (fat * 9)) / 4);
            
            // Update game state
            gameState.goals = { calories, protein, carbs, fat };
            
            updateDisplay();
            closeModal('goalsModal');
            showToast('Goals updated! 🎯', 'success');
            saveGameState();
        }

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function saveGameState() {
            // Load custom foods into catalog
            gameState.customFoods.forEach(food => {
                if (!FOODS_CATALOG.some(f => f.id === food.id)) {
                    FOODS_CATALOG.push(food);
                }
            });
        }

        function loadGameState() {
            // Initialize with custom foods if any
            if (gameState.customFoods) {
                gameState.customFoods.forEach(food => {
                    if (!FOODS_CATALOG.some(f => f.id === food.id)) {
                        FOODS_CATALOG.push(food);
                    }
                });
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize the app when page loads
        window.onload = init;
    </script>
</body>
</html>
